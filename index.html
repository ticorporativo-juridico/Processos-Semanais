<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Semanal de Processos</title>
    <!-- Carrega o Tailwind CSS para um layout moderno e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configura√ß√£o de Fonte Padr√£o e Estilos Globais */
        :root {
            /* Cor prim√°ria (Slate/Chumbo) */
            --color-primary: #475569; 
            --color-secondary: #64748b; 
            --color-bg: #f8fafc; /* Super Light Gray */
            --color-report-primary: #10B981; /* Verde Esmeralda para Relat√≥rio */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
        }
        
        /* Estilos customizados para as colunas do Kanban */
        .board-column {
            min-width: 300px;
            max-width: 350px;
            flex-shrink: 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
            /* Configura√ß√£o para rolagem interna na coluna */
            max-height: 70vh; /* Altura m√°xima para ativar a rolagem (70% do viewport) */
            overflow-y: auto; /* Habilita a rolagem vertical */
        }
        
        /* Estilo para fixar o t√≠tulo da coluna (Kanban Header Sticky) */
        .kanban-header-sticky {
            position: sticky;
            top: 0; 
            z-index: 10;
            background-color: white; 
            padding-top: 1.25rem; 
            margin-top: -1.25rem; 
            padding-left: 1.25rem; 
            margin-left: -1.25rem; 
            padding-right: 1.25rem; 
            margin-right: -1.25rem; 
            padding-bottom: 1rem; 
            margin-bottom: 0.5rem; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.06);
        }
        
        /* Estilos para a barra de rolagem (melhor compatibilidade com Webkit) */
        .board-column::-webkit-scrollbar {
            width: 8px;
        }
        .board-column::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; 
            border-radius: 20px;
        }
        .board-column::-webkit-scrollbar-track {
            background-color: transparent; 
        }
        .board-column:hover::-webkit-scrollbar-thumb {
            background-color: #94a3b8; 
        }

        .task-card {
            transition: transform 0.2s, box-shadow 0.3s;
            border-left-width: 6px; 
            border-radius: 0.75rem; 
        }
        .task-card:hover {
            transform: translateY(-3px); 
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Cores de status */
        .status-tratamento { border-left-color: #ea580c; } 
        .status-tratados { border-left-color: #10b981; } 
        .status-proximos { border-left-color: #6366f1; } 
        .status-concluido-hist { border-left-color: #6b7280; } 

        /* Estilo para a data no card */
        .card-date {
            background-color: #e0f2f7; 
            color: #155e75; 
            padding: 2px 8px;
            border-radius: 9999px; 
            font-weight: 600;
        }
        /* Estilo para a data de CONCLUS√ÉO (destaque verde) */
        .card-done {
            background-color: #d1fae5; 
            color: #065f46; 
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 0.5rem;
        }
        /* Estilo para o modal */
        #edit-modal, #report-modal {
            backdrop-filter: blur(5px);
        }

        /* Classes de relat√≥rio */
        .text-report { color: var(--color-report-primary); }
        .focus-report { border-color: var(--color-report-primary); box-shadow: 0 0 0 1px var(--color-report-primary); }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Cabe√ßalho Principal Moderno -->
    <header class="bg-gradient-to-r from-slate-800 to-indigo-700 rounded-xl shadow-2xl p-8 mb-4 text-center">
        <h1 class="text-4xl font-black text-white">Dashboard de Acompanhamento Semanal</h1>
        <p class="text-indigo-200 mt-2 text-lg">Vis√£o din√¢mica e eficiente dos processos da equipe.</p>
    </header>

    <!-- Se√ß√£o de Filtros e Relat√≥rio -->
    <div class="bg-white rounded-xl shadow-lg p-6 grid grid-cols-1 md:grid-cols-6 gap-4 items-end border-t-4 border-indigo-400 mb-8">
        <h2 class="text-xl font-bold text-slate-700 col-span-full md:col-span-6 border-b pb-2">Ferramentas e Filtros:</h2>

        <!-- Filtro por Colaborador -->
        <div class="col-span-full sm:col-span-2 lg:col-span-2">
            <label for="filter-colaborador" class="text-sm font-medium text-gray-600 mb-1">Filtrar por Colaborador</label>
            <select id="filter-colaborador" onchange="filterCards()" class="p-2 border-2 border-gray-200 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 shadow-inner w-full">
                <option value="todos" class="font-bold">Todos os Colaboradores</option>
                <!-- Op√ß√µes preenchidas pelo JS -->
            </select>
        </div>

        <!-- Filtro por Data (Previs√£o de Conclus√£o) -->
        <div class="col-span-full sm:col-span-2 lg:col-span-2">
            <label for="filter-date" class="text-sm font-medium text-gray-600 mb-1">Filtrar por Data (Previs√£o)</label>
            <input type="date" id="filter-date" onchange="filterCards()" class="p-2 border-2 border-gray-200 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 shadow-inner w-full">
        </div>

        <!-- Bot√£o Limpar Filtros -->
        <div class="col-span-full sm:col-span-1 lg:col-span-1">
            <button onclick="clearFilters()" class="bg-gray-700 text-white hover:bg-gray-800 px-4 py-2 rounded-xl font-semibold transition duration-200 shadow-md min-h-[44px] w-full mt-4 sm:mt-0">
                Limpar Filtros
            </button>
        </div>

        <!-- NOVO: Bot√£o de Extra√ß√£o de Relat√≥rio (Restrito) -->
        <div class="col-span-full sm:col-span-1 lg:col-span-1">
            <button onclick="openReportModal()" class="bg-emerald-600 text-white hover:bg-emerald-700 px-4 py-2 rounded-xl font-bold transition duration-200 shadow-md min-h-[44px] w-full mt-4 sm:mt-0">
                Extrair Relat√≥rio (üîí)
            </button>
        </div>
    </div>
    
    <!-- FIM da Se√ß√£o de Filtros -->

    <!-- T√çTULO DE SE√á√ÉO para o Kanban Board -->
    <h2 class="text-3xl font-black text-slate-700 mt-8 mb-4">Kanban de Processos</h2>
    
    <!-- Dashboard Kanban -->
    <div class="flex space-x-6 overflow-x-auto pt-2 pb-6">
        
        <!-- Coluna 1: Em Tratamento -->
        <div id="column-tratamento" class="board-column bg-white p-5 rounded-2xl shadow-xl">
            <h3 class="kanban-header-sticky text-xl font-extrabold text-orange-700 border-b-4 border-orange-300 flex items-center">
                <span class="mr-2 text-2xl">üî•</span> Em Tratamento
            </h3>
        </div>

        <!-- Coluna 2: Tratados na Semana -->
        <div id="column-tratados" class="board-column bg-white p-5 rounded-2xl shadow-xl">
            <h3 class="kanban-header-sticky text-xl font-extrabold text-emerald-600 border-b-4 border-emerald-300 flex items-center">
                <span class="mr-2 text-2xl">‚ú®</span> Tratados na Semana
            </h3>
        </div>

        <!-- Coluna 3: Pr√≥ximos Processos -->
        <div id="column-proximos" class="board-column bg-white p-5 rounded-2xl shadow-xl">
            <h3 class="kanban-header-sticky text-xl font-extrabold text-indigo-600 border-b-4 border-indigo-300 flex items-center">
                <span class="mr-2 text-2xl">üöÄ</span> Pr√≥ximos Processos
            </h3>
        </div>
        
        <!-- Coluna 4: Hist√≥rico de Conclu√≠dos -->
        <div id="column-concluidos-historico" class="board-column bg-white p-5 rounded-2xl shadow-xl">
            <h3 class="kanban-header-sticky text-xl font-extrabold text-slate-600 border-b-4 border-slate-300 flex items-center">
                <span class="mr-2 text-2xl">‚úÖ</span> Hist√≥rico de Conclu√≠dos
            </h3>
        </div>
        
    </div>

    <!-- Formul√°rio de Entrada de Dados (Mantido) -->
    <div class="bg-white rounded-xl shadow-2xl p-8 mt-8 border-l-8 border-indigo-500">
        <h2 class="text-3xl font-black text-gray-800 mb-6 border-b pb-3">‚úçÔ∏è Registrar Novo Processo (Carimbo do Tempo)</h2>
        <form id="process-form" class="grid grid-cols-1 md:grid-cols-4 gap-6">
            
            <!-- Campos do formul√°rio (Omitidos para brevidade, mas o c√≥digo completo est√° no JS) -->
            <div class="col-span-full md:col-span-1">
                <label for="colaborador" class="block text-sm font-semibold text-gray-700">Colaborador</label>
                <select id="colaborador" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-50"></select>
            </div>
            <div class="col-span-full md:col-span-1">
                <label for="processo-status" class="block text-sm font-semibold text-gray-700">Status do Processo</label>
                <select id="processo-status" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-50">
                    <option value="tratamento">Em Tratamento</option>
                    <option value="proximos">Pr√≥ximos Processos</option>
                    <option value="tratados">Status: Tratados (Selecione Conclus√£o abaixo)</option>
                </select>
            </div>
            <div class="col-span-full md:col-span-1">
                <label for="data-registro" class="block text-sm font-semibold text-gray-700">Data de Registro (Inclus√£o)</label>
                <input type="date" id="data-registro" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-50">
            </div>
            <div class="col-span-full md:col-span-1">
                <label for="data-previsao" class="block text-sm font-semibold text-gray-700">Data de Previs√£o (Conclus√£o) - Opcional</label>
                <input type="date" id="data-previsao" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-50">
            </div>
            <div class="col-span-full md:col-span-2">
                <label for="data-conclusao" class="block text-sm font-extrabold text-emerald-700">‚≠ê Data de Conclus√£o (Opcional, se J√Å feito)</label>
                <input type="date" id="data-conclusao" class="mt-1 block w-full p-3 border-2 border-emerald-300 rounded-lg shadow-md focus:ring-emerald-500 focus:border-emerald-500 transition duration-150 bg-emerald-50">
            </div>
            <div class="col-span-full">
                <label for="processo-nome" class="block text-sm font-semibold text-gray-700">Nome do Processo/Tarefa</label>
                <input type="text" id="processo-nome" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Fechamento mensal Cliente Alpha">
            </div>
            <div class="col-span-full">
                <label for="detalhes" class="block text-sm font-semibold text-gray-700">Detalhes/Descri√ß√£o</label>
                <textarea id="detalhes" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 h-24" placeholder="O que est√° sendo feito ou o que foi/ser√° feito..."></textarea>
            </div>
            <div class="col-span-full text-right">
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition duration-200 transform hover:scale-[1.02]">
                    Adicionar Processo
                </button>
            </div>
        </form>
    </div>

    <!-- Modal de Edi√ß√£o (Mantido) -->
    <div id="edit-modal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-75 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-3xl p-8 w-full max-w-lg border-t-8 border-indigo-600 relative">
                <button onclick="closeEditModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></svg>
                </button>
                <h2 class="text-2xl font-black text-slate-700 mb-6">‚úèÔ∏è Editar Processo</h2>
                
                <form id="edit-form" onsubmit="handleEditSubmit(event)">
                    <input type="hidden" id="edit-id">
                    
                    <div class="mb-4">
                        <label for="edit-nome" class="block text-sm font-semibold text-gray-700">Nome do Processo/Tarefa</label>
                        <input type="text" id="edit-nome" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="edit-colaborador" class="block text-sm font-semibold text-gray-700">Colaborador</label>
                            <select id="edit-colaborador" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"></select>
                        </div>
                        <div>
                            <label for="edit-status" class="block text-sm font-semibold text-gray-700">Status</label>
                            <select id="edit-status" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                                <option value="tratamento">Em Tratamento</option>
                                <option value="proximos">Pr√≥ximos Processos</option>
                                <option value="tratados">Status: Tratados</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="edit-data-registro" class="block text-sm font-semibold text-gray-700">Data de Registro (Inclus√£o)</label>
                            <input type="date" id="edit-data-registro" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                        </div>
                        <div>
                            <label for="edit-data-previsao" class="block text-sm font-semibold text-gray-700">Data de Previs√£o - Opcional</label>
                            <input type="date" id="edit-data-previsao" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                        </div>
                    </div>
                    <div class="mb-6">
                        <label for="edit-data-conclusao" class="block text-sm font-extrabold text-emerald-700">‚≠ê Data de Conclus√£o (Finalizado)</label>
                        <input type="date" id="edit-data-conclusao" class="mt-1 block w-full p-3 border-2 border-emerald-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 shadow-sm bg-emerald-50">
                    </div>
                    <div class="mb-6">
                        <label for="edit-detalhes" class="block text-sm font-semibold text-gray-700">Detalhes/Descri√ß√£o</label>
                        <textarea id="edit-detalhes" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 h-24 shadow-sm"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeEditModal()" class="bg-gray-200 text-gray-700 hover:bg-gray-300 font-bold py-2 px-4 rounded-xl transition duration-150 shadow-md">Cancelar</button>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition duration-150">Salvar Altera√ß√µes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- NOVO: Modal de Extra√ß√£o de Relat√≥rio (Acesso Restrito) -->
    <div id="report-modal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-75 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-3xl p-8 w-full max-w-4xl border-t-8 border-report-primary relative">
                <button onclick="closeReportModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></svg>
                </button>
                
                <div id="report-message-area" class="mb-4 hidden p-3 rounded-lg font-medium" role="alert"></div>

                <!-- Estado: Login (Inicial) -->
                <div id="report-login-section" class="space-y-6 text-center">
                    <h2 class="text-2xl font-black text-gray-700 border-b pb-2">Acesso Exclusivo ao Relat√≥rio</h2>
                    <p class="text-sm text-gray-500">Insira as credenciais da Dra. C√°ssia ou Dra. Jana√≠na.</p>

                    <div class="flex flex-col sm:flex-row gap-4 max-w-md mx-auto">
                        <input type="text" id="report-user-name" placeholder="Nome (Ex: Dra. C√°ssia)"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus-report focus:border-report-primary transition duration-150"
                               autocomplete="username">
                        <input type="password" id="report-user-pin" placeholder="PIN (Senha)"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus-report focus:border-report-primary transition duration-150"
                               autocomplete="current-password"
                               maxlength="4">
                    </div>

                    <button id="extract-report-button"
                            class="mx-auto bg-emerald-600 text-white py-3 px-6 rounded-xl font-bold text-lg hover:bg-emerald-700 transition duration-200 shadow-md shadow-emerald-300/50 flex items-center justify-center max-w-md"
                            disabled>
                        <span id="report-button-text">Aguardando Dados...</span>
                        <svg id="report-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>

                <!-- Estado: Relat√≥rio (Ap√≥s login bem-sucedido) -->
                <div id="report-display-section" class="hidden">
                    <h2 class="text-2xl font-black text-gray-800 border-b pb-2 mb-4 text-report">Relat√≥rio Semanal de Processos (Acesso Concedido)</h2>
                    <div id="report-content" class="h-[60vh] overflow-y-auto pr-2">
                        <!-- Conte√∫do da tabela ser√° injetado aqui -->
                    </div>
                    <button onclick="handleReportLogout()"
                            class="mt-6 w-full bg-red-500 text-white py-2 rounded-xl font-bold hover:bg-red-600 transition duration-200">
                        Sair e Bloquear Relat√≥rio
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- L√ìGICA JAVASCRIPT E FIREBASE -->
    <script type="module">
        // Importa as bibliotecas do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // Vari√°veis Globais do Ambiente (MANDAT√ìRIO USAR)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth;
        
        // Dados do Kanban (usa localStorage)
        const colaboradores = [
            'Beatriz', 'Diego', 'Emily', 'Felipe', 'Hosana', 
            'Jo√£o', 'Mariane', 'Rebeca', 'Tairane', 'Thais'
        ];
        let processos = []; 

        // Dados do Relat√≥rio (usa Firebase)
        let authorizedUsers = [];
        let mockProcesses = [];
        let isReportAuthenticated = false;

        // Elementos UI do Relat√≥rio
        const reportModal = document.getElementById('report-modal');
        const reportLoginSection = document.getElementById('report-login-section');
        const reportDisplaySection = document.getElementById('report-display-section');
        const reportContent = document.getElementById('report-content');
        const reportMessageArea = document.getElementById('report-message-area');
        const reportUserNameInput = document.getElementById('report-user-name');
        const reportUserPinInput = document.getElementById('report-user-pin');
        const extractReportButton = document.getElementById('extract-report-button');
        const reportButtonText = document.getElementById('report-button-text');
        const reportLoadingSpinner = document.getElementById('report-loading-spinner');

        // ------------------ Fun√ß√µes de Utilit√°rio Comuns ------------------

        function getTodayDateString() {
            return new Date().toISOString().split('T')[0];
        }

        function isWithinCurrentWeek(dateString) {
            if (!dateString) return false;
            const targetDate = new Date(dateString + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            const oneDay = 1000 * 60 * 60 * 24;
            const dayOfWeek = today.getDay(); 
            const startOfWeek = new Date(today.getTime() - dayOfWeek * oneDay); 
            const endOfWeek = new Date(startOfWeek.getTime() + 6 * oneDay);    
            endOfWeek.setHours(23, 59, 59, 999);
            return targetDate >= startOfWeek && targetDate <= endOfWeek;
        }

        function formatDate(dateString) {
            if (!dateString) return null;
            const dateObj = new Date(dateString + 'T00:00:00');
            if (!isNaN(dateObj) && dateObj.getFullYear() > 1900) {
                return dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }
            return 'Data Inv√°lida';
        }
        
        // Fun√ß√£o para mostrar mensagens no Modal de Relat√≥rio
        function displayReportMessage(text, type = 'error') {
            const baseClasses = 'p-3 rounded-lg font-medium';
            let classes;
            if (type === 'success') {
                classes = `${baseClasses} bg-green-100 text-green-700 border border-green-300`;
            } else if (type === 'error') {
                classes = `${baseClasses} bg-red-100 text-red-700 border border-red-300`;
            } else if (type === 'info') {
                classes = `${baseClasses} bg-blue-100 text-blue-700 border border-blue-300`;
            }

            reportMessageArea.className = classes;
            reportMessageArea.innerHTML = text;
            reportMessageArea.classList.remove('hidden');

            setTimeout(() => {
                reportMessageArea.classList.add('hidden');
            }, 5000);
        }

        // ------------------ Fun√ß√µes de Persist√™ncia Kanban (localStorage) ------------------

        function saveProcesses() {
            try {
                localStorage.setItem('processosDashboard', JSON.stringify(processos));
            } catch (e) {
                console.error("Erro ao salvar dados Kanban:", e);
            }
        }

        function loadProcesses() {
            try {
                const storedProcesses = localStorage.getItem('processosDashboard');
                if (storedProcesses) {
                    const loaded = JSON.parse(storedProcesses);
                    processos = loaded.map(p => ({
                        dataRegistro: p.dataRegistro || p.data || getTodayDateString(), 
                        dataPrevisao: p.dataPrevisao || p.data || '', 
                        dataConclusao: p.dataConclusao || '', 
                        ...p,
                    }));
                }
            } catch (e) {
                console.error("Erro ao carregar dados Kanban:", e);
                processos = [];
            }
        }
        
        // ------------------ Fun√ß√µes de UI Kanban (Mantidas) ------------------

        function setupCollaboratorSelects() {
            // ... (L√≥gica de preenchimento dos selects)
            const selects = [
                document.getElementById('filter-colaborador'),
                document.getElementById('colaborador'),
                document.getElementById('edit-colaborador')
            ];

            document.getElementById('data-registro').value = getTodayDateString();

            colaboradores.forEach(nome => {
                const option = document.createElement('option');
                option.value = nome;
                option.textContent = nome;

                selects.forEach(select => select.appendChild(option.cloneNode(true)));
            });
        }

        function createCard(processo) {
            // ... (L√≥gica de cria√ß√£o do Card Kanban)
            let statusClass;
            statusClass = isWithinCurrentWeek(processo.dataConclusao) ? 'tratados' : (processo.dataConclusao ? 'concluido-hist' : (processo.status === 'proximos' ? 'proximos' : 'tratamento'));

            const card = document.createElement('div');
            card.className = `task-card bg-white p-4 rounded-xl shadow-lg mb-4 text-sm status-${statusClass}`;
            
            card.setAttribute('data-colaborador', processo.colaborador);
            card.setAttribute('data-previsao', processo.dataPrevisao || '');
            card.setAttribute('data-status', processo.status);

            const previsaoDisplay = formatDate(processo.dataPrevisao) || 'Indefinida';
            const registroDisplay = formatDate(processo.dataRegistro) || 'Indefinida';
            const conclusaoDisplay = formatDate(processo.dataConclusao); 
            
            let conclusaoHtml = '';
            if (conclusaoDisplay) {
                const conclusaoText = isWithinCurrentWeek(processo.dataConclusao) ? 'Conclu√≠do Esta Semana' : 'Conclu√≠do em Hist√≥rico';
                conclusaoHtml = `<span class="card-done text-xs" title="${conclusaoText}">‚úÖ ${conclusaoDisplay}</span>`;
            }

            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="font-extrabold text-gray-800 text-base">${processo.nome}</div>
                    <div class="flex space-x-2">
                        <button onclick="openEditModal(${processo.id})" title="Editar Processo" class="text-gray-400 hover:text-indigo-600 transition duration-150 p-1 rounded-full focus:outline-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                        </button>
                        <button onclick="deleteProcess(${processo.id})" title="Excluir Processo" class="text-gray-400 hover:text-red-600 transition duration-150 p-1 rounded-full focus:outline-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-between items-center mb-2">
                    <div class="text-xs text-gray-500">Colab: <span class="font-bold text-gray-700">${processo.colaborador}</span></div>
                    <span class="card-date text-xs" title="Previs√£o de Conclus√£o">Prev.: ${previsaoDisplay}</span>
                </div>
                
                <div class="flex justify-between items-center mt-2 mb-2">
                    <div class="text-xs text-gray-400">Registro: ${registroDisplay}</div>
                    ${conclusaoHtml}
                </div>
                
                <div class="text-gray-600 whitespace-pre-wrap mt-3 pt-3 border-t border-gray-100">${processo.detalhes}</div>
            `;
            return card;
        }

        function renderDashboard() {
            // ... (L√≥gica de renderiza√ß√£o e ordena√ß√£o do Kanban)
            const tratamento = [];
            const tratadosSemana = [];
            const proximos = [];
            const historico = [];

            processos.forEach(processo => {
                const isConcluido = !!processo.dataConclusao;

                if (isConcluido) {
                    if (isWithinCurrentWeek(processo.dataConclusao)) {
                        tratadosSemana.push(processo);
                    } else {
                        historico.push(processo);
                    }
                } else {
                    switch (processo.status) {
                        case 'proximos':
                            proximos.push(processo);
                            break;
                        case 'tratamento':
                        case 'tratados':
                        default:
                            tratamento.push(processo);
                            break;
                    }
                }
            });
            
            // ORDENA√á√ÉO: Hist√≥rico de Conclu√≠dos (Mais Recente Primeiro)
            historico.sort((a, b) => {
                if (!a.dataConclusao) return 1; 
                if (!b.dataConclusao) return -1;
                return b.dataConclusao.localeCompare(a.dataConclusao);
            });
            
            // Limpa e recria os t√≠tulos das colunas
            const columnTreatment = document.getElementById('column-tratamento');
            const columnDoneWeek = document.getElementById('column-tratados');
            const columnNext = document.getElementById('column-proximos');
            const columnHistory = document.getElementById('column-concluidos-historico');
            
            columnTreatment.innerHTML = '<h3 class="kanban-header-sticky text-xl font-extrabold text-orange-700 border-b-4 border-orange-300 flex items-center"><span class="mr-2 text-2xl">üî•</span> Em Tratamento</h3>';
            columnDoneWeek.innerHTML = '<h3 class="kanban-header-sticky text-xl font-extrabold text-emerald-600 border-b-4 border-emerald-300 flex items-center"><span class="mr-2 text-2xl">‚ú®</span> Tratados na Semana</h3>';
            columnNext.innerHTML = '<h3 class="kanban-header-sticky text-xl font-extrabold text-indigo-600 border-b-4 border-indigo-300 flex items-center"><span class="mr-2 text-2xl">üöÄ</span> Pr√≥ximos Processos</h3>';
            columnHistory.innerHTML = '<h3 class="kanban-header-sticky text-xl font-extrabold text-slate-600 border-b-4 border-slate-300 flex items-center"><span class="mr-2 text-2xl">‚úÖ</span> Hist√≥rico de Conclu√≠dos</h3>';

            tratamento.forEach(processo => columnTreatment.appendChild(createCard(processo)));
            tratadosSemana.forEach(processo => columnDoneWeek.appendChild(createCard(processo)));
            proximos.forEach(processo => columnNext.appendChild(createCard(processo)));
            historico.forEach(processo => columnHistory.appendChild(createCard(processo)));

            filterCards();
        }

        // ... (openEditModal, closeEditModal, handleEditSubmit, deleteProcess, filterCards, clearFilters, Form Submit Logic - Mantidos)
        
        function openEditModal(id) {
            const processo = processos.find(p => p.id === id);
            if (!processo) {
                console.error(`Processo com ID ${id} n√£o encontrado para edi√ß√£o.`);
                return;
            }

            document.getElementById('edit-id').value = processo.id;
            document.getElementById('edit-nome').value = processo.nome;
            document.getElementById('edit-colaborador').value = processo.colaborador;
            document.getElementById('edit-status').value = processo.status;
            document.getElementById('edit-data-registro').value = processo.dataRegistro;
            document.getElementById('edit-data-previsao').value = processo.dataPrevisao || ''; 
            document.getElementById('edit-data-conclusao').value = processo.dataConclusao || ''; 
            document.getElementById('edit-detalhes').value = processo.detalhes;

            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        function handleEditSubmit(e) {
            e.preventDefault();

            const id = parseInt(document.getElementById('edit-id').value);
            const index = processos.findIndex(p => p.id === id);

            if (index === -1) {
                console.error(`Erro ao salvar: Processo com ID ${id} n√£o encontrado.`);
                return;
            }

            const dataPrevisao = document.getElementById('edit-data-previsao').value.trim();
            const dataConclusao = document.getElementById('edit-data-conclusao').value.trim(); 

            processos[index] = {
                ...processos[index], 
                colaborador: document.getElementById('edit-colaborador').value,
                status: document.getElementById('edit-status').value,
                nome: document.getElementById('edit-nome').value,
                dataRegistro: document.getElementById('edit-data-registro').value,
                dataPrevisao: dataPrevisao, 
                dataConclusao: dataConclusao, 
                detalhes: document.getElementById('edit-detalhes').value || 'Nenhum detalhe fornecido.',
            };

            saveProcesses();
            renderDashboard();
            closeEditModal();
            console.log(`Processo ${id} editado com sucesso.`);
        }


        function deleteProcess(id) {
            const initialLength = processos.length;
            processos = processos.filter(processo => processo.id !== id);

            if (processos.length < initialLength) {
                saveProcesses();
                renderDashboard();
                console.log(`Processo com ID ${id} exclu√≠do com sucesso.`);
            } else {
                console.warn(`Processo com ID ${id} n√£o encontrado.`);
            }
        }

        function filterCards() {
            const filterColab = document.getElementById('filter-colaborador').value;
            const filterDate = document.getElementById('filter-date').value;
            const allCards = document.querySelectorAll('.task-card');

            allCards.forEach(card => {
                const cardColab = card.getAttribute('data-colaborador');
                const cardPrevisao = card.getAttribute('data-previsao'); 
                let matches = true;

                if (filterColab !== 'todos' && cardColab !== filterColab) {
                    matches = false;
                }

                if (filterDate && cardPrevisao !== filterDate) {
                    matches = false;
                }

                card.style.display = matches ? 'block' : 'none';
            });
        }
        
        function clearFilters() {
            document.getElementById('filter-colaborador').value = 'todos';
            document.getElementById('filter-date').value = '';
            filterCards();
        }

        document.getElementById('process-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const dataPrevisaoValue = document.getElementById('data-previsao').value.trim();
            const dataRegistroValue = document.getElementById('data-registro').value;
            const dataConclusaoValue = document.getElementById('data-conclusao').value.trim(); 

            const novoProcesso = {
                colaborador: document.getElementById('colaborador').value,
                status: document.getElementById('processo-status').value,
                nome: document.getElementById('processo-nome').value,
                dataRegistro: dataRegistroValue,
                dataPrevisao: dataPrevisaoValue,
                dataConclusao: dataConclusaoValue, 
                detalhes: document.getElementById('detalhes').value || 'Nenhum detalhe fornecido.',
                id: Date.now() 
            };

            processos.push(novoProcesso);
            saveProcesses();
            renderDashboard();
            
            document.getElementById('processo-nome').value = '';
            document.getElementById('data-previsao').value = ''; 
            document.getElementById('data-conclusao').value = ''; 
            document.getElementById('detalhes').value = '';
            document.getElementById('data-registro').value = getTodayDateString(); 
        });

        // ------------------ Fun√ß√µes de Inicializa√ß√£o (Kanban) ------------------
        
        function setInitialKanbanData() {
            if (processos.length === 0) {
                const today = getTodayDateString();
                const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0]; 
                const twoDaysAgo = new Date(Date.now() - 2 * 86400000).toISOString().split('T')[0]; 
                const nextWeek = new Date(Date.now() + 7 * 86400000).toISOString().split('T')[0];
                const lastWeek = new Date(Date.now() - 7 * 86400000).toISOString().split('T')[0];
                const twoWeeksAgo = new Date(Date.now() - 14 * 86400000).toISOString().split('T')[0];

                processos = [
                    { colaborador: 'Beatriz', status: 'tratamento', nome: 'An√°lise de Relat√≥rio de Custos', dataRegistro: yesterday, dataPrevisao: today, dataConclusao: '', detalhes: 'Revisando as despesas de TI e Pessoal. Prioridade alta.', id: 1 },
                    { colaborador: 'Diego', status: 'tratados', nome: 'Migra√ß√£o de Servidor Cloud', dataRegistro: yesterday, dataPrevisao: yesterday, dataConclusao: today, detalhes: 'Migra√ß√£o para novo ambiente AWS conclu√≠da com sucesso e documentada.', id: 2 },
                    { colaborador: 'Mariane', status: 'tratados', nome: 'Fechamento Cont√°bil do M√™s', dataRegistro: twoDaysAgo, dataPrevisao: lastWeek, dataConclusao: yesterday, detalhes: 'Fechamento finalizado e documentos enviados ao setor financeiro.', id: 6 },
                    { colaborador: 'Felipe', status: 'tratados', nome: 'Revis√£o Contratual Cliente Gama', dataRegistro: lastWeek, dataPrevisao: lastWeek, dataConclusao: twoWeeksAgo, detalhes: 'Contrato revisto e assinado. Processo de arquivamento finalizado.', id: 5 },
                    { colaborador: 'Emily', status: 'proximos', nome: 'Planejamento de Campanha Q4', dataRegistro: today, dataPrevisao: nextWeek, dataConclusao: '', detalhes: 'Definir budget, criar criativos e segmentar p√∫blico-alvo.', id: 3 },
                    { colaborador: 'Jo√£o', status: 'tratamento', nome: 'Atendimento Cliente Y (Chamado 456)', dataRegistro: today, dataPrevisao: '', dataConclusao: '', detalhes: 'Aguardando feedback do cliente sobre a proposta enviada.', id: 4 },
                ];
            }
        }
        
        // ------------------ L√≥gica de Acesso e Relat√≥rio (Firebase) ------------------

        function openReportModal() {
            reportModal.classList.remove('hidden');
            // Se j√° estiver autenticado, vai direto para o relat√≥rio
            if (isReportAuthenticated) {
                toggleReportView(true);
            } else {
                toggleReportView(false);
            }
        }

        function closeReportModal() {
            reportModal.classList.add('hidden');
            displayReportMessage('', 'info'); // Limpa mensagens
        }

        function toggleReportView(loggedIn) {
            isReportAuthenticated = loggedIn;
            if (loggedIn) {
                reportLoginSection.classList.add('hidden');
                reportDisplaySection.classList.remove('hidden');
                renderReport();
            } else {
                reportDisplaySection.classList.add('hidden');
                reportLoginSection.classList.remove('hidden');
                reportUserNameInput.value = '';
                reportUserPinInput.value = '';
            }
        }

        function renderReport() {
            if (mockProcesses.length === 0) {
                reportContent.innerHTML = '<p class="text-gray-500 italic text-center mt-8">Nenhum processo simulado encontrado no sistema.</p>';
                return;
            }

            // Ordena os processos mockados pela data de entrada (mais recentes primeiro)
            mockProcesses.sort((a, b) => b.data_entrada.localeCompare(a.data_entrada));

            let html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Protocolo</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Entrada</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100">
            `;

            mockProcesses.forEach(p => {
                const statusColor = p.status === 'Conclu√≠do' ? 'bg-green-100 text-green-800' :
                                    p.status === 'Em An√°lise' ? 'bg-yellow-100 text-yellow-800' :
                                    'bg-blue-100 text-blue-800';

                html += `
                    <tr>
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${p.protocolo}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-600">${p.cliente}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-600">${formatDate(p.data_entrada)}</td>
                        <td class="px-3 py-2 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${p.status}
                            </span>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                <p class="text-right text-xs text-gray-400 italic mt-4">Dados simulados. Total de Processos: ${mockProcesses.length}</p>
            `;

            reportContent.innerHTML = html;
        }

        function handleReportAuthentication() {
            const name = reportUserNameInput.value.trim();
            const pin = reportUserPinInput.value.trim();

            if (!name || !pin) {
                displayReportMessage("Por favor, preencha o Nome e a Senha (PIN).", 'error');
                return;
            }
            
            reportLoadingSpinner.classList.remove('hidden');
            reportButtonText.textContent = 'Verificando...';
            extractReportButton.disabled = true;

            const user = authorizedUsers.find(u => 
                u.name.toLowerCase() === name.toLowerCase() && u.pin === pin
            );
            
            setTimeout(() => { 
                reportLoadingSpinner.classList.add('hidden');
                reportButtonText.textContent = 'Extrair Relat√≥rio';
                extractReportButton.disabled = false;

                if (user) {
                    displayReportMessage(`Acesso concedido. Bem-vinda, ${user.name}!`, 'success');
                    toggleReportView(true);
                } else {
                    displayReportMessage("Nome ou Senha (PIN) incorretos. Acesso negado.", 'error');
                }
            }, 800);
        }
        
        function handleReportLogout() {
             displayReportMessage("Sess√£o encerrada. Relat√≥rio bloqueado.", 'info');
             toggleReportView(false);
        }

        // ------------------ Fun√ß√µes de Inicializa√ß√£o (Firebase) ------------------

        async function initializeFirebase() {
            if (!firebaseConfig.apiKey) {
                 console.error("Firebase Configura√ß√£o Inv√°lida. Apenas o Kanban funcionar√°.");
                 extractReportButton.disabled = false;
                 reportButtonText.textContent = 'Extrair Relat√≥rio';
                 return;
            }

            try {
                // setLogLevel('debug');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                setupReportDataListener();
                
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                displayReportMessage(`Falha ao conectar ao sistema de seguran√ßa.`, 'error');
            }
        }

        function setupReportDataListener() {
            // Caminho: /artifacts/{appId}/public/data/authorized_users/config
            const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'authorized_users', 'config');

            const initialConfig = {
                // Usu√°rios autorizados: Dra. C√°ssia e Dra. Jana√≠na
                users: [
                    { name: 'Dra. C√°ssia', pin: '1234' },
                    { name: 'Dra. Jana√≠na', pin: '5678' }
                ],
                // Dados simulados para o relat√≥rio
                mock_processes: [
                    { id: 1, protocolo: '2024/00123', cliente: 'Empresa Alfa', status: 'Em An√°lise', data_entrada: '2024-10-01' },
                    { id: 2, protocolo: '2024/00124', cliente: 'Cliente Beta', status: 'Em Andamento', data_entrada: '2024-10-02' },
                    { id: 3, protocolo: '2024/00125', cliente: 'Ind√∫stria Gamma', status: 'Conclu√≠do', data_entrada: '2024-10-05' },
                    { id: 4, protocolo: '2024/00126', cliente: 'Startup Delta', status: 'Em An√°lise', data_entrada: '2024-10-08' },
                    { id: 5, protocolo: '2024/00127', cliente: 'Com√©rcio Epsilon', status: 'Conclu√≠do', data_entrada: '2024-10-10' },
                    { id: 6, protocolo: '2024/00128', cliente: 'Servi√ßos Zeta', status: 'Em Andamento', data_entrada: '2024-10-12' },
                    { id: 7, protocolo: '2024/00129', cliente: 'Construtora Lambda', status: 'Em Andamento', data_entrada: '2024-10-15' },
                    { id: 8, protocolo: '2024/00130', cliente: 'Escrit√≥rio Omega', status: 'Conclu√≠do', data_entrada: '2024-10-14' },
                ]
            };

            // Garante que o documento exista no Firestore
            setDoc(configRef, initialConfig, { merge: true })
                .catch(err => console.error("Erro ao garantir dados iniciais de configura√ß√£o:", err));

            // Listener para monitorar a lista de usu√°rios e processos
            onSnapshot(configRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    authorizedUsers = data.users || [];
                    mockProcesses = data.mock_processes || [];
                    
                    extractReportButton.disabled = false;
                    reportButtonText.textContent = 'Extrair Relat√≥rio';
                } else {
                    authorizedUsers = initialConfig.users;
                    mockProcesses = initialConfig.mock_processes;
                }
            }, (error) => {
                console.error("Erro no listener de dados do Relat√≥rio:", error);
            });
        }


        // Event Listeners (Relat√≥rio)
        extractReportButton.addEventListener('click', handleReportAuthentication);
        reportUserPinInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !extractReportButton.disabled) {
                handleReportAuthentication();
            }
        });


        // Inicializa√ß√£o Principal
        document.addEventListener('DOMContentLoaded', () => {
            setupCollaboratorSelects(); 
            loadProcesses(); 
            setInitialKanbanData(); 
            renderDashboard(); 
            initializeFirebase(); // Inicializa o Firebase para a fun√ß√£o de relat√≥rio
        });

    </script>
</body>
</html>
