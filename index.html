<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Semanal de Processos</title>
    <!-- Carrega o Tailwind CSS para um layout moderno e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configura√ß√£o de Fonte Padr√£o e Estilos Globais */
        :root {
            /* Cor prim√°ria (Slate/Chumbo) */
            --color-primary: #475569; 
            --color-secondary: #64748b; 
            --color-bg: #f8fafc; /* Super Light Gray */
            --color-report-primary: #10B981; /* Verde Esmeralda para Relat√≥rio */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
        }
        
        /* Estilos customizados para as colunas do Kanban */
        .board-column {
            min-width: 300px;
            max-width: 350px;
            flex-shrink: 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
            /* Configura√ß√£o para rolagem interna na coluna */
            max-height: 70vh; /* Altura m√°xima para ativar a rolagem (70% do viewport) */
            overflow-y: auto; /* Habilita a rolagem vertical */
        }
        
        /* Estilo para fixar o t√≠tulo da coluna (Kanban Header Sticky) */
        .kanban-header-sticky {
            position: sticky;
            top: 0; 
            z-index: 10;
            background-color: white; 
            padding-top: 1.25rem; 
            margin-top: -1.25rem; 
            padding-left: 1.25rem; 
            margin-left: -1.25rem; 
            padding-right: 1.25rem; 
            margin-right: -1.25rem; 
            padding-bottom: 1rem; 
            margin-bottom: 0.5rem; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.06);
        }
        
        /* Estilos para a barra de rolagem (melhor compatibilidade com Webkit) */
        .board-column::-webkit-scrollbar {
            width: 8px;
        }
        .board-column::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; 
            border-radius: 20px;
        }
        .board-column::-webkit-scrollbar-track {
            background-color: transparent; 
        }
        .board-column:hover::-webkit-scrollbar-thumb {
            background-color: #94a3b8; 
        }

        .task-card {
            transition: transform 0.2s, box-shadow 0.3s;
            border-left-width: 6px; 
            border-radius: 0.75rem; 
        }
        .task-card:hover {
            transform: translateY(-3px); 
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Cores de status */
        .status-tratamento { border-left-color: #ea580c; } 
        .status-tratados { border-left-color: #10b981; } 
        .status-proximos { border-left-color: #6366f1; } 
        .status-concluido-hist { border-left-color: #6b7280; } 

        /* Estilo para a data no card */
        .card-date {
            background-color: #e0f2f7; 
            color: #155e75; 
            padding: 2px 8px;
            border-radius: 9999px; 
            font-weight: 600;
        }
        /* Estilo para a data de CONCLUS√ÉO (destaque verde) */
        .card-done {
            background-color: #d1fae5; 
            color: #065f46; 
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 0.5rem;
        }
        /* Estilo para o modal */
        #edit-modal, #report-modal {
            backdrop-filter: blur(5px);
        }

        /* Classes de relat√≥rio */
        .text-report { color: var(--color-report-primary); }
        .focus-report { border-color: var(--color-report-primary) !important; box-shadow: 0 0 0 1px var(--color-report-primary) !important; }
        
        /* ============================================== */
        /* NOVO: Efeito de Piscar Alerta (Blinking Alert Effect) */
        /* ============================================== */
        @keyframes blink-red {
            0%, 100% {
                /* Sombra e Borda: Vermelho Intenso */
                box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.7); 
                border-color: #ef4444; 
                background-color: #fef2f2; /* Fundo levemente vermelho */
            }
            50% {
                /* Sombra e Borda: Transparente/Suave */
                box-shadow: 0 0 0 0px rgba(239, 68, 68, 0);
                border-color: #fca5a5; 
                background-color: #fff;
            }
        }

        .alert-blink {
            animation: blink-red 1s infinite;
            border-left-color: #ef4444 !important; /* For√ßa a borda esquerda vermelha */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Cabe√ßalho Principal Moderno -->
    <header class="bg-gradient-to-r from-slate-800 to-indigo-700 rounded-xl shadow-2xl p-8 mb-4 text-center">
        <h1 class="text-4xl font-black text-white">Dashboard de Acompanhamento Semanal</h1>
        <p class="text-indigo-200 mt-2 text-lg">Vis√£o din√¢mica e eficiente dos processos da equipe.</p>
    </header>

    <!-- Se√ß√£o de Filtros e Relat√≥rio -->
    <div class="bg-white rounded-xl shadow-lg p-6 grid grid-cols-1 md:grid-cols-6 gap-4 items-end border-t-4 border-indigo-400 mb-8">
        <h2 class="text-xl font-bold text-slate-700 col-span-full md:col-span-6 border-b pb-2">Ferramentas e Filtros:</h2>

        <!-- Filtro por Colaborador -->
        <div class="col-span-full sm:col-span-2 lg:col-span-2">
            <label for="filter-colaborador" class="text-sm font-medium text-gray-600 mb-1">Filtrar por Colaborador</label>
            <select id="filter-colaborador" onchange="filterCards()" class="p-2 border-2 border-gray-200 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 shadow-inner w-full">
                <option value="todos" class="font-bold">Todos os Colaboradores</option>
                <!-- As op√ß√µes de Colaboradores s√£o injetadas aqui pelo JavaScript -->
            </select>
        </div>

        <!-- Filtro por Data (Previs√£o de Conclus√£o) -->
        <div class="col-span-full sm:col-span-2 lg:col-span-2">
            <label for="filter-date" class="text-sm font-medium text-gray-600 mb-1">Filtrar por Data (Previs√£o)</label>
            <input type="date" id="filter-date" onchange="filterCards()" class="p-2 border-2 border-gray-200 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 shadow-inner w-full">
        </div>

        <!-- Bot√£o Limpar Filtros -->
        <div class="col-span-full sm:col-span-1 lg:col-span-1">
            <button onclick="clearFilters()" class="bg-gray-700 text-white hover:bg-gray-800 px-4 py-2 rounded-xl font-semibold transition duration-200 shadow-md min-h-[44px] w-full mt-4 sm:mt-0">
                Limpar Filtros
            </button>
        </div>

        <!-- Bot√£o de Extra√ß√£o de Relat√≥rio (Restrito) -->
        <div class="col-span-full sm:col-span-1 lg:col-span-1">
            <button onclick="openReportModal()" class="bg-emerald-600 text-white hover:bg-emerald-700 px-4 py-2 rounded-xl font-bold transition duration-200 shadow-md min-h-[44px] w-full mt-4 sm:mt-0">
                Extrair Relat√≥rio (üîí)
            </button>
        </div>
    </div>
    
    <!-- FIM da Se√ß√£o de Filtros -->

    <!-- T√çTULO DE SE√á√ÉO para o Kanban Board -->
    <h2 class="text-3xl font-black text-slate-700 mt-8 mb-4">Kanban de Processos</h2>
    
    <!-- Dashboard Kanban -->
    <div class="flex space-x-6 overflow-x-auto pt-2 pb-6">
        
        <!-- Coluna 1: Em Tratamento -->
        <div id="column-tratamento" class="board-column bg-white p-5 rounded-2xl shadow-xl">
            <h3 class="kanban-header-sticky text-xl font-extrabold text-orange-700 border-b-4 border-orange-300 flex items-center">
                <span class="mr-2 text-2xl">üî•</span> Em Tratamento
            </h3>
        </div>

        <!-- Coluna 2: Tratados na Semana -->
        <div id="column-tratados" class="board-column bg-white p-5 rounded-2xl shadow-xl">
            <h3 class="kanban-header-sticky text-xl font-extrabold text-emerald-600 border-b-4 border-emerald-300 flex items-center">
                <span class="mr-2 text-2xl">‚ú®</span> Tratados na Semana
            </h3>
        </div>

        <!-- Coluna 3: Pr√≥ximos Processos -->
        <div id="column-proximos" class="board-column bg-white p-5 rounded-2xl shadow-xl">
            <h3 class="kanban-header-sticky text-xl font-extrabold text-indigo-600 border-b-4 border-indigo-300 flex items-center">
                <span class="mr-2 text-2xl">üöÄ</span> Pr√≥ximos Processos
            </h3>
        </div>
        
        <!-- Coluna 4: Hist√≥rico de Conclu√≠dos -->
        <div id="column-concluidos-historico" class="board-column bg-white p-5 rounded-2xl shadow-xl">
            <h3 class="kanban-header-sticky text-xl font-extrabold text-slate-600 border-b-4 border-slate-300 flex items-center">
                <span class="mr-2 text-2xl">‚úÖ</span> Hist√≥rico de Conclu√≠dos
            </h3>
        </div>
        
    </div>

    <!-- Formul√°rio de Entrada de Dados (Mantido) -->
    <div class="bg-white rounded-xl shadow-2xl p-8 mt-8 border-l-8 border-indigo-500">
        <h2 class="text-3xl font-black text-gray-800 mb-6 border-b pb-3">‚úçÔ∏è Registrar Novo Processo (Carimbo do Tempo)</h2>
        <form id="process-form" class="grid grid-cols-1 md:grid-cols-4 gap-6">
            
            <!-- Campos do formul√°rio -->
            <div class="col-span-full md:col-span-1">
                <label for="colaborador" class="block text-sm font-semibold text-gray-700">Colaborador</label>
                <!-- ID 'colaborador' √© preenchido pelo JS -->
                <select id="colaborador" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-50"></select>
            </div>
            <div class="col-span-full md:col-span-1">
                <label for="processo-status" class="block text-sm font-semibold text-gray-700">Status do Processo</label>
                <select id="processo-status" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-50">
                    <option value="tratamento">Em Tratamento</option>
                    <option value="proximos">Pr√≥ximos Processos</option>
                    <option value="tratados">Status: Tratados (Selecione Conclus√£o abaixo)</option>
                </select>
            </div>
            <div class="col-span-full md:col-span-1">
                <label for="data-registro" class="block text-sm font-semibold text-gray-700">Data de Registro (Inclus√£o)</label>
                <input type="date" id="data-registro" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-50">
            </div>
            <div class="col-span-full md:col-span-1">
                <label for="data-previsao" class="block text-sm font-semibold text-gray-700">Data de Previs√£o (Conclus√£o) - Opcional</label>
                <input type="date" id="data-previsao" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-50">
            </div>
            <div class="col-span-full md:col-span-2">
                <label for="data-conclusao" class="block text-sm font-extrabold text-emerald-700">‚≠ê Data de Conclus√£o (Opcional, se J√Å feito)</label>
                <input type="date" id="data-conclusao" class="mt-1 block w-full p-3 border-2 border-emerald-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition duration-150 bg-emerald-50">
            </div>
            <div class="col-span-full">
                <label for="processo-nome" class="block text-sm font-semibold text-gray-700">Nome do Processo/Tarefa</label>
                <input type="text" id="processo-nome" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Fechamento mensal Cliente Alpha">
            </div>
            <div class="col-span-full">
                <label for="detalhes" class="block text-sm font-semibold text-gray-700">Detalhes/Descri√ß√£o</label>
                <textarea id="detalhes" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 h-24" placeholder="O que est√° sendo feito ou o que foi/ser√° feito..."></textarea>
            </div>
            <div class="col-span-full text-right">
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition duration-200 transform hover:scale-[1.02]">
                    Adicionar Processo
                </button>
            </div>
        </form>
    </div>

    <!-- Modal de Edi√ß√£o (Mantido) -->
    <div id="edit-modal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-75 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-3xl p-8 w-full max-w-lg border-t-8 border-indigo-600 relative">
                <button onclick="closeEditModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <h2 class="text-2xl font-black text-slate-700 mb-6">‚úèÔ∏è Editar Processo</h2>
                
                <form id="edit-form" onsubmit="handleEditSubmit(event)">
                    <input type="hidden" id="edit-id">
                    
                    <div class="mb-4">
                        <label for="edit-nome" class="block text-sm font-semibold text-gray-700">Nome do Processo/Tarefa</label>
                        <input type="text" id="edit-nome" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="edit-colaborador" class="block text-sm font-semibold text-gray-700">Colaborador</label>
                            <!-- ID 'edit-colaborador' √© preenchido pelo JS -->
                            <select id="edit-colaborador" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"></select>
                        </div>
                        <div>
                            <label for="edit-status" class="block text-sm font-semibold text-gray-700">Status</label>
                            <select id="edit-status" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                                <option value="tratamento">Em Tratamento</option>
                                <option value="proximos">Pr√≥ximos Processos</option>
                                <option value="tratados">Status: Tratados</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="edit-data-registro" class="block text-sm font-semibold text-gray-700">Data de Registro (Inclus√£o)</label>
                            <input type="date" id="edit-data-registro" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                        </div>
                        <div>
                            <label for="edit-data-previsao" class="block text-sm font-semibold text-gray-700">Data de Previs√£o - Opcional</label>
                            <input type="date" id="edit-data-previsao" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                        </div>
                    </div>
                    <div class="mb-6">
                        <label for="edit-data-conclusao" class="block text-sm font-extrabold text-emerald-700">‚≠ê Data de Conclus√£o (Finalizado)</label>
                        <input type="date" id="edit-data-conclusao" class="mt-1 block w-full p-3 border-2 border-emerald-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 shadow-sm bg-emerald-50">
                    </div>
                    <div class="mb-6">
                        <label for="edit-detalhes" class="block text-sm font-semibold text-gray-700">Detalhes/Descri√ß√£o</label>
                        <textarea id="edit-detalhes" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 h-24 shadow-sm"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeEditModal()" class="bg-gray-200 text-gray-700 hover:bg-gray-300 font-bold py-2 px-4 rounded-xl transition duration-150 shadow-md">Cancelar</button>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition duration-150">Salvar Altera√ß√µes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal de Extra√ß√£o de Relat√≥rio (Acesso Restrito) -->
    <div id="report-modal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-75 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-3xl p-8 w-full max-w-4xl border-t-8 border-report-primary relative">
                <button onclick="closeReportModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                
                <div id="report-message-area" class="mb-4 hidden p-3 rounded-lg font-medium" role="alert"></div>

                <!-- Estado: Login (Inicial) -->
                <div id="report-login-section" class="space-y-6 text-center">
                    <h2 class="text-2xl font-black text-gray-700 border-b pb-2">Acesso Exclusivo ao Relat√≥rio</h2>
                    <p class="text-sm text-gray-500">Insira suas credenciais de acesso restrito. Use o üëÅÔ∏è para verificar se a senha est√° correta.</p>

                    <div class="flex flex-col sm:flex-row gap-4 max-w-md mx-auto">
                        <input type="text" id="report-user-name" placeholder="Nome (Ex: C√°ssia ou Dra. C√°ssia)"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus-report focus:border-report-primary transition duration-150"
                                autocomplete="username">
                        
                        <!-- NOVO WRAPPER PARA TOGGLE DE PIN -->
                        <div class="relative w-full">
                            <input type="password" id="report-user-pin" placeholder="PIN Secreto (6 Caracteres)"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus-report focus:border-report-primary transition duration-150 pr-10"
                                    autocomplete="current-password"
                                    maxlength="6">
                            <button type="button" id="toggle-pin-visibility" 
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600" 
                                    onclick="togglePinVisibility()">
                                <!-- √çcone de Olho Fechado (Padr√£o) -->
                                <svg id="eye-closed-icon" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.057 10.057 0 0112 19c-4.478 0-8.268-2.943-9.544-7 1.276-4.057 5.066-7 9.544-7a9.954 9.954 0 011.875.175M16 12a4 4 0 11-8 0 4 4 0 018 0zM17 19l-4-4"></path></svg>
                                <!-- √çcone de Olho Aberto (Escondido) -->
                                <svg id="eye-open-icon" class="h-5 w-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0zM2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            </button>
                        </div>
                        <!-- FIM DO NOVO WRAPPER -->

                    </div>

                    <button id="extract-report-button" onclick="handleReportAuthentication(event)"
                            class="mx-auto bg-emerald-600 text-white py-3 px-6 rounded-xl font-bold text-lg hover:bg-emerald-700 transition duration-200 shadow-md shadow-emerald-300/50 flex items-center justify-center max-w-md w-full">
                        <span id="report-button-text">Extrair Relat√≥rio</span>
                        <svg id="report-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>

                <!-- Estado: Relat√≥rio (Ap√≥s login bem-sucedido) -->
                <div id="report-display-section" class="hidden">
                    <h2 class="text-2xl font-black text-gray-800 border-b pb-2 mb-4 text-report">Relat√≥rio Semanal de Processos (Acesso Concedido)</h2>
                    <div id="report-content" class="h-[60vh] overflow-y-auto pr-2">
                        <!-- Conte√∫do da tabela ser√° injetado aqui -->
                    </div>
                    
                    <!-- NOVO BOT√ÉO DE EXPORTA√á√ÉO PARA CSV/EXCEL -->
                    <button onclick="downloadReportAsCsv()"
                            class="mt-4 w-full bg-green-600 text-white py-2 rounded-xl font-bold hover:bg-green-700 transition duration-200 shadow-md">
                        Baixar Relat√≥rio Completo (CSV/Excel)
                    </button>

                    <button onclick="handleReportLogout()"
                            class="mt-3 w-full bg-red-500 text-white py-2 rounded-xl font-bold hover:bg-red-600 transition duration-200">
                        Sair e Bloquear Relat√≥rio
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- L√ìGICA JAVASCRIPT E FIREBASE (COMPLETA) -->
    <script type="module">
        // Importa as bibliotecas do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        // Ativa o log para debug do Firestore
        // setLogLevel('debug');

        // Vari√°veis Globais do Ambiente (MANDAT√ìRIO USAR)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth;
        let userId = 'anon-user';
        let processesRef; // Refer√™ncia da Cole√ß√£o de Processos
        let reportCredsRef; // Refer√™ncia do Documento de Credenciais
        let isAuthReady = false;
        
        // ====================================================================
        // LISTA COMPLETA DE COLABORADORES
        // ====================================================================
        const colaboradores = [
            'Beatriz', 'Diego', 'Emily', 'Felipe', 'Hosana', 
            'Jo√£o', 'Mariane', 'Rebeca', 'Tairane', 'Thais'
        ];
        // Vari√°vel que armazena todos os processos
        let processos = []; 

        // Constante para definir os usu√°rios autorizados (Fallback e Inicial)
        // **IMPORTANTE**: As credenciais reais ser√£o lidas do Firestore.
        const initialAuthorizedUsers = [
            // PINs: 1234$C e 5678$J
            { name: 'Dra. C√°ssia', pin: '1234$C' }, 
            { name: 'Dra. Jana√≠na', pin: '5678$J' }
        ];

        let authorizedUsers = [...initialAuthorizedUsers]; 
        let isReportAuthenticated = false;

        // Elementos UI do Relat√≥rio
        const reportModal = document.getElementById('report-modal');
        const reportLoginSection = document.getElementById('report-login-section');
        const reportDisplaySection = document.getElementById('report-display-section');
        const reportContent = document.getElementById('report-content');
        const reportMessageArea = document.getElementById('report-message-area');
        const reportUserNameInput = document.getElementById('report-user-name');
        const reportUserPinInput = document.getElementById('report-user-pin');
        const extractReportButton = document.getElementById('extract-report-button');
        const reportButtonText = document.getElementById('report-button-text');
        const reportLoadingSpinner = document.getElementById('report-loading-spinner');

        // ====================================================================
        // 1. FIREBASE SETUP & AUTHENTICATION
        // ====================================================================

        async function initializeFirebase() {
            try {
                // Inicializa o Firebase (se ainda n√£o estiver inicializado)
                try {
                    // Tenta obter a inst√¢ncia existente para evitar re-inicializa√ß√£o
                    getApp(); 
                } catch (e) {
                    initializeApp(firebaseConfig);
                }
                
                auth = getAuth();
                db = getFirestore();

                // 1. Autentica√ß√£o: prioriza o token customizado
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                
                // 2. Define os caminhos de persist√™ncia (Cole√ß√£o P√∫blica)
                processesRef = collection(db, 'artifacts', appId, 'public', 'data', 'processes');
                reportCredsRef = doc(db, 'artifacts', appId, 'public', 'data', 'report_credentials', 'authorized_list');

                // 3. Inicializa listeners para dados (incluindo credenciais do relat√≥rio)
                subscribeToReportCredentials();
                subscribeToProcesses();
                
                isAuthReady = true;
                console.log(`Firebase Inicializado. UserId: ${userId}`);

            } catch (error) {
                console.error("Erro na inicializa√ß√£o do Firebase:", error);
            }
        }

        // ====================================================================
        // 2. CORE FIRESTORE LISTENERS
        // ====================================================================

        /**
         * Listener para os processos do Kanban.
         */
        function subscribeToProcesses() {
            if (!processesRef) return;

            onSnapshot(processesRef, (snapshot) => {
                const fetchedProcesses = [];
                snapshot.forEach(doc => {
                    // Mapeia o documento e adiciona o ID como campo.
                    fetchedProcesses.push({ 
                        id: doc.id,
                        ...doc.data()
                    });
                });
                // Garante que o array principal seja atualizado e o Kanban renderizado.
                processos = fetchedProcesses.sort((a, b) => new Date(a.dataRegistro) - new Date(b.dataRegistro));
                renderKanban();
            }, (error) => {
                console.error("Erro ao receber updates de processos:", error);
            });
        }
        
        /**
         * Listener para as credenciais de acesso ao relat√≥rio.
         */
        function subscribeToReportCredentials() {
            if (!reportCredsRef) return;

            onSnapshot(reportCredsRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().users) {
                    authorizedUsers = docSnap.data().users;
                    console.log("Credenciais de relat√≥rio atualizadas via Firestore.");
                } else {
                    // Se o documento n√£o existir, o cria com os valores iniciais.
                    setDoc(reportCredsRef, { users: initialAuthorizedUsers }, { merge: true })
                        .then(() => console.log("Documento de credenciais inicializado."))
                        .catch(e => console.error("Erro ao inicializar credenciais:", e));
                }
            }, (error) => {
                console.error("Erro ao receber updates de credenciais:", error);
                authorizedUsers = initialAuthorizedUsers; // Usa fallback em caso de erro
            });
        }
        
        // ====================================================================
        // 3. CORE CRUD FUNCTIONS (Firestore)
        // ====================================================================

        /**
         * Adiciona um novo processo ou o inicializa se n√£o tiver ID.
         */
        async function addOrUpdateProcess(data, id = null) {
            if (!isAuthReady) {
                console.error("Firebase n√£o est√° pronto para opera√ß√µes de escrita.");
                return;
            }
            try {
                if (id) {
                    // Atualiza o documento existente
                    const processDocRef = doc(db, processesRef.path, id);
                    await updateDoc(processDocRef, data);
                    console.log(`Processo ID: ${id} atualizado com sucesso.`);
                } else {
                    // Cria um novo documento (o Firestore gera o ID automaticamente)
                    const newDocRef = doc(processesRef);
                    await setDoc(newDocRef, { ...data, id: newDocRef.id });
                    console.log(`Novo processo adicionado com ID: ${newDocRef.id}`);
                }
            } catch (e) {
                console.error(`Erro ao salvar/atualizar processo (ID: ${id}):`, e);
            }
        }
        
        /**
         * Exclui um processo.
         */
        async function deleteProcess(id) {
            if (!isAuthReady || !id) {
                console.error("Firebase n√£o est√° pronto ou ID ausente.");
                return;
            }
            
            // Substitui o alert/confirm com uma l√≥gica de UI (aqui usamos console.log para simplificar, mas em prod seria um modal)
            if (window.confirm(`Tem certeza que deseja DELETAR o processo ID: ${id}?`)) {
                 try {
                    const processDocRef = doc(db, processesRef.path, id);
                    await deleteDoc(processDocRef);
                    console.log(`Processo ID: ${id} deletado com sucesso.`);
                } catch (e) {
                    console.error("Erro ao deletar processo:", e);
                }
            }
        }

        // ====================================================================
        // 4. UI UTILITIES AND RENDERING
        // ====================================================================

        function getTodayDateString() {
            return new Date().toISOString().split('T')[0];
        }
        
        /**
         * NOVO: Verifica se a data de previs√£o est√° a exatamente um dia (amanh√£).
         */
        function isOneDayFromDue(previsaoDateString) {
            if (!previsaoDateString) return false;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0); // In√≠cio de hoje

            const previsionDate = new Date(previsaoDateString + 'T00:00:00');
            previsionDate.setHours(0, 0, 0, 0); // In√≠cio do dia da previs√£o

            // Calcula a diferen√ßa em dias (arredonda para cima)
            const diffTime = previsionDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

            // O processo est√° a um dia da conclus√£o se a diferen√ßa for exatamente 1
            // e maior que zero (ou seja, amanh√£ √© o prazo)
            return diffDays === 1;
        }


        function isWithinCurrentWeek(dateString) {
            if (!dateString) return false;
            const targetDate = new Date(dateString + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            const oneDay = 1000 * 60 * 60 * 24;
            const dayOfWeek = today.getDay(); 
            // Calcula o in√≠cio da semana (Domingo)
            const startOfWeek = new Date(today.getTime() - dayOfWeek * oneDay); 
            // Calcula o fim da semana (S√°bado)
            const endOfWeek = new Date(startOfWeek.getTime() + 6 * oneDay); 
            endOfWeek.setHours(23, 59, 59, 999);
            return targetDate >= startOfWeek && targetDate <= endOfWeek;
        }

        function formatDate(dateString) {
            if (!dateString) return null;
            const dateObj = new Date(dateString + 'T00:00:00');
            if (!isNaN(dateObj) && dateObj.getFullYear() > 1900) {
                return dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }
            return 'Data Inv√°lida';
        }
        
        // Fun√ß√£o para mostrar mensagens no Modal de Relat√≥rio
        function displayReportMessage(text, type = 'error') {
            const baseClasses = 'p-3 rounded-lg font-medium';
            let classes;
            if (type === 'success') {
                classes = `${baseClasses} bg-green-100 text-green-700 border border-green-300`;
            } else if (type === 'error') {
                classes = `${baseClasses} bg-red-100 text-red-700 border border-red-300`;
            } else if (type === 'info') {
                classes = `${baseClasses} bg-blue-100 text-blue-700 border border-blue-300`;
            }

            reportMessageArea.className = classes;
            reportMessageArea.innerHTML = text;
            reportMessageArea.classList.remove('hidden');

            setTimeout(() => {
                reportMessageArea.classList.add('hidden');
            }, 5000);
        }

        function togglePinVisibility() {
            const pinInput = document.getElementById('report-user-pin');
            const eyeOpen = document.getElementById('eye-open-icon');
            const eyeClosed = document.getElementById('eye-closed-icon');

            if (pinInput.type === 'password') {
                pinInput.type = 'text';
                eyeOpen.classList.remove('hidden');
                eyeClosed.classList.add('hidden');
            } else {
                pinInput.type = 'password';
                eyeClosed.classList.remove('hidden');
                eyeOpen.classList.add('hidden');
            }
        }


        function setupCollaboratorSelects() {
            const filterSelect = document.getElementById('filter-colaborador');
            const newSelect = document.getElementById('colaborador');
            const editSelect = document.getElementById('edit-colaborador');
            
            const selectsToPopulate = [filterSelect, newSelect, editSelect].filter(s => s !== null);

            if (document.getElementById('data-registro')) {
                document.getElementById('data-registro').value = getTodayDateString();
            }

            [newSelect, editSelect].forEach(select => {
                if (select) select.innerHTML = '';
            });

            // Cria e anexa as op√ß√µes de colaboradores
            colaboradores.forEach(nome => {
                const option = document.createElement('option');
                option.value = nome;
                option.textContent = nome;

                selectsToPopulate.forEach(select => {
                    select.appendChild(option.cloneNode(true));
                });
            });
        }

        function createCard(processo) {
            const isDone = processo.dataConclusao;
            
            // 1. L√≥gica de Alerta de Prazo
            const isDueTomorrow = !isDone && processo.dataPrevisao && isOneDayFromDue(processo.dataPrevisao);
            
            // 2. Define a classe de status visual baseada na data de conclus√£o ou status do Kanban
            let statusClass;
            // Se conclu√≠do na semana atual, status √© 'tratados' (verde)
            if (isWithinCurrentWeek(processo.dataConclusao)) {
                statusClass = 'tratados';
            } 
            // Se conclu√≠do, mas em outra semana, status √© 'concluido-hist' (cinza)
            else if (isDone) {
                statusClass = 'concluido-hist';
            } 
            // Caso contr√°rio, usa o status do Kanban (tratamento ou proximos)
            else {
                statusClass = processo.status === 'proximos' ? 'proximos' : 'tratamento';
            }

            // 3. Adiciona a classe de blink se o alerta for verdadeiro
            let cardClasses = `task-card bg-white p-4 rounded-xl shadow-lg mb-4 text-sm status-${statusClass} transition duration-300`;
            if (isDueTomorrow) {
                cardClasses += ' alert-blink';
            }

            const card = document.createElement('div');
            card.className = cardClasses;
            card.setAttribute('data-id', processo.id);
            card.setAttribute('data-colaborador', processo.colaborador);
            card.setAttribute('data-previsao', processo.dataPrevisao || '');

            const dateDisplay = isDone 
                ? `<span class="card-done ml-2">CONCLU√çDO em ${formatDate(processo.dataConclusao)}</span>`
                : (processo.dataPrevisao ? `<span class="card-date ml-2">Previs√£o: ${formatDate(processo.dataPrevisao)}</span>` : '');
            
            // 4. Cria a mensagem de alerta visual
            const alertInfo = isDueTomorrow
                ? `<div class="p-1.5 bg-red-100 text-red-700 font-bold rounded-md text-xs mt-2 flex items-center">
                    <svg class="w-4 h-4 mr-1 animate-pulse" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.564 2.87-1.564 3.635 0l3.097 6.338C15.772 10.368 15.016 11 14.12 11H5.88c-.896 0-1.652-.632-1.93-1.563l3.097-6.338zM19 19a1 1 0 01-1 1H2a1 1 0 010-2h16a1 1 0 011 1z" clip-rule="evenodd"></path></svg>
                    PRAZO PR√ìXIMO! Previs√£o para amanh√£.
                  </div>`
                : '';


            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs font-semibold uppercase text-slate-500">${processo.colaborador}</span>
                    <div class="flex space-x-2">
                        <button onclick="openEditModal('${processo.id}')" class="text-indigo-500 hover:text-indigo-700 p-1 rounded-full hover:bg-indigo-50 transition duration-150">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-9-6l9 9"></path></svg>
                        </button>
                        <button onclick="deleteProcess('${processo.id}')" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50 transition duration-150">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
                <h4 class="text-base font-bold text-gray-800 mb-1">${processo.processoNome}</h4>
                <p class="text-gray-600 text-xs mb-3">${processo.detalhes.substring(0, 100)}...</p>
                <div class="flex items-center text-xs text-gray-500 mt-2 border-t pt-2">
                    <span class="font-medium mr-2">Reg.: ${formatDate(processo.dataRegistro)}</span>
                    ${dateDisplay}
                </div>
                ${alertInfo}
            `;
            return card;
        }

        function renderKanban(filteredProcesses = processos) {
            // Limpa todas as colunas
            document.getElementById('column-tratamento').querySelectorAll('.task-card').forEach(c => c.remove());
            document.getElementById('column-tratados').querySelectorAll('.task-card').forEach(c => c.remove());
            document.getElementById('column-proximos').querySelectorAll('.task-card').forEach(c => c.remove());
            document.getElementById('column-concluidos-historico').querySelectorAll('.task-card').forEach(c => c.remove());

            // Seleciona os cont√™ineres de coluna
            const cols = {
                tratamento: document.getElementById('column-tratamento'),
                tratados: document.getElementById('column-tratados'),
                proximos: document.getElementById('column-proximos'),
                'concluidos-historico': document.getElementById('column-concluidos-historico')
            };
            
            // Renderiza os cards nas colunas corretas
            filteredProcesses.forEach(processo => {
                let statusCol;
                // L√≥gica de status para direcionamento do card
                if (isWithinCurrentWeek(processo.dataConclusao)) {
                    statusCol = 'tratados'; // Conclu√≠dos esta semana
                } else if (processo.dataConclusao) {
                    statusCol = 'concluidos-historico'; // Conclu√≠dos em outras datas
                } else {
                    statusCol = processo.status; // Tratamento ou Pr√≥ximos
                }

                if (cols[statusCol]) {
                    cols[statusCol].appendChild(createCard(processo));
                }
            });
            
            console.log(`Kanban renderizado. ${filteredProcesses.length} processos vis√≠veis.`);
        }
        
        // ====================================================================
        // 5. FORMUL√ÅRIO E MODAL DE EDI√á√ÉO
        // ====================================================================

        document.getElementById('process-form').addEventListener('submit', handleFormSubmit);

        function handleFormSubmit(event) {
            event.preventDefault();
            
            const newProcess = {
                processoNome: document.getElementById('processo-nome').value.trim(),
                colaborador: document.getElementById('colaborador').value,
                status: document.getElementById('processo-status').value,
                dataRegistro: document.getElementById('data-registro').value,
                dataPrevisao: document.getElementById('data-previsao').value,
                dataConclusao: document.getElementById('data-conclusao').value,
                detalhes: document.getElementById('detalhes').value,
                criadoEm: new Date().toISOString()
            };

            if (!newProcess.processoNome || !newProcess.colaborador || !newProcess.dataRegistro) {
                // Em um ambiente de produ√ß√£o, seria um modal de erro
                console.error("Campos obrigat√≥rios faltando!");
                return;
            }

            addOrUpdateProcess(newProcess);

            // Limpa o formul√°rio, mas mant√©m a data de registro de hoje
            document.getElementById('process-form').reset();
            document.getElementById('data-registro').value = getTodayDateString();
        }

        function openEditModal(id) {
            const processo = processos.find(p => p.id === id);
            if (!processo) {
                console.error("Processo n√£o encontrado para edi√ß√£o:", id);
                return;
            }

            // Preenche o modal
            document.getElementById('edit-id').value = processo.id;
            document.getElementById('edit-nome').value = processo.processoNome;
            document.getElementById('edit-colaborador').value = processo.colaborador;
            document.getElementById('edit-status').value = processo.status;
            document.getElementById('edit-data-registro').value = processo.dataRegistro;
            document.getElementById('edit-data-previsao').value = processo.dataPrevisao;
            document.getElementById('edit-data-conclusao').value = processo.dataConclusao;
            document.getElementById('edit-detalhes').value = processo.detalhes;
            
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        function handleEditSubmit(event) {
            event.preventDefault();

            const id = document.getElementById('edit-id').value;
            
            const updatedProcess = {
                processoNome: document.getElementById('edit-nome').value.trim(),
                colaborador: document.getElementById('edit-colaborador').value,
                status: document.getElementById('edit-status').value,
                dataRegistro: document.getElementById('edit-data-registro').value,
                dataPrevisao: document.getElementById('edit-data-previsao').value,
                dataConclusao: document.getElementById('edit-data-conclusao').value,
                detalhes: document.getElementById('edit-detalhes').value,
                editadoEm: new Date().toISOString()
            };

            addOrUpdateProcess(updatedProcess, id);
            closeEditModal();
        }


        // ====================================================================
        // 6. FUN√á√ïES DE FILTRO
        // ====================================================================

        function filterCards() {
            const filterColaborador = document.getElementById('filter-colaborador').value;
            const filterDate = document.getElementById('filter-date').value;

            let filtered = processos.filter(p => {
                // Filtro por Colaborador
                const matchesColaborador = filterColaborador === 'todos' || p.colaborador === filterColaborador;

                // Filtro por Data (Previs√£o)
                const matchesDate = !filterDate || (p.dataPrevisao === filterDate);

                return matchesColaborador && matchesDate;
            });

            renderKanban(filtered);
        }

        function clearFilters() {
            document.getElementById('filter-colaborador').value = 'todos';
            document.getElementById('filter-date').value = '';
            renderKanban(); 
        }

        // ====================================================================
        // 7. RELAT√ìRIO (RESTRI√á√ÉO DE ACESSO)
        // ====================================================================
        
        function openReportModal() {
            reportModal.classList.remove('hidden');
            // Garante que a tela de login/display correta seja mostrada ao abrir
            if (isReportAuthenticated) {
                showReportDisplay();
            } else {
                showReportLogin();
            }
        }

        function closeReportModal() {
            reportModal.classList.add('hidden');
            reportUserPinInput.value = ''; // Limpa o PIN ao fechar
        }

        function showReportLogin() {
            reportLoginSection.classList.remove('hidden');
            reportDisplaySection.classList.add('hidden');
            reportButtonText.textContent = "Extrair Relat√≥rio";
            reportLoadingSpinner.classList.add('hidden');
        }

        function showReportDisplay() {
            reportLoginSection.classList.add('hidden');
            reportDisplaySection.classList.remove('hidden');
            generateReportTable();
        }
        
        async function handleReportAuthentication(event) {
            event.preventDefault();
            
            const name = reportUserNameInput.value.trim();
            const pin = reportUserPinInput.value.trim();

            if (!name || pin.length !== 6) {
                displayReportMessage("Nome ou PIN (6 caracteres) inv√°lido.", 'error');
                return;
            }

            // Ativa o loading
            extractReportButton.disabled = true;
            reportButtonText.textContent = "Verificando...";
            reportLoadingSpinner.classList.remove('hidden');

            // Simula√ß√£o de verifica√ß√£o de PIN
            const user = authorizedUsers.find(u => u.name.toLowerCase() === name.toLowerCase() && u.pin === pin);

            // Aguarda um pouco para simular o processo (melhora a UX)
            await new Promise(resolve => setTimeout(resolve, 1500)); 

            if (user) {
                isReportAuthenticated = true;
                displayReportMessage(`Acesso concedido para ${user.name}! Gerando relat√≥rio...`, 'success');
                showReportDisplay();
            } else {
                isReportAuthenticated = false;
                displayReportMessage("Credenciais de acesso negadas. Verifique o nome e PIN.", 'error');
                showReportLogin(); // Volta para a tela de login
            }
            
            extractReportButton.disabled = false;
            reportLoadingSpinner.classList.add('hidden');
        }
        
        function handleReportLogout() {
            isReportAuthenticated = false;
            displayReportMessage("Relat√≥rio bloqueado com sucesso.", 'info');
            showReportLogin();
        }

        function generateReportTable() {
            if (!isReportAuthenticated) {
                reportContent.innerHTML = `<p class="text-center text-red-500 font-semibold mt-4">Acesso n√£o autorizado. Por favor, fa√ßa login.</p>`;
                return;
            }
            
            if (processos.length === 0) {
                 reportContent.innerHTML = `<p class="text-center text-gray-500 font-semibold mt-4">Nenhum processo registrado para gerar o relat√≥rio.</p>`;
                 return;
            }

            // Cria o cabe√ßalho da tabela
            let tableHtml = `
                <div class="shadow-lg rounded-xl overflow-hidden mb-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-report-primary text-white sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">ID</th>
                                <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Nome</th>
                                <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Colaborador</th>
                                <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Reg.</th>
                                <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Prev.</th>
                                <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Conc.</th>
                                <th class="px-4 py-3 text-left text-xs font-bold uppercase tracking-wider">Detalhes</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;

            // Adiciona as linhas (ordenadas por data de registro)
            processos.forEach(p => {
                const statusText = p.dataConclusao 
                    ? (isWithinCurrentWeek(p.dataConclusao) ? 'Conclu√≠do na Semana' : 'Conclu√≠do Hist√≥rico') 
                    : (p.status === 'proximos' ? 'Pr√≥ximo' : 'Em Tratamento');
                    
                const statusClass = p.dataConclusao 
                    ? (isWithinCurrentWeek(p.dataConclusao) ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800')
                    : (p.status === 'proximos' ? 'bg-indigo-100 text-indigo-800' : 'bg-orange-100 text-orange-800');

                tableHtml += `
                    <tr>
                        <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-500">${p.id.substring(0, 6)}...</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${p.processoNome}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${p.colaborador}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatDate(p.dataRegistro)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${p.dataPrevisao ? formatDate(p.dataPrevisao) : '-'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${p.dataConclusao ? formatDate(p.dataConclusao) : '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-500 max-w-xs overflow-hidden text-ellipsis whitespace-nowrap">${p.detalhes || '-'}</td>
                    </tr>
                `;
            });

            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            reportContent.innerHTML = tableHtml;
        }
        
        /**
         * NOVO: Baixa o relat√≥rio completo em formato CSV.
         */
        function downloadReportAsCsv() {
            if (!isReportAuthenticated || processos.length === 0) {
                displayReportMessage("N√£o √© poss√≠vel baixar: acesso n√£o autorizado ou sem dados.", 'error');
                return;
            }

            const headers = [
                "ID", "Nome do Processo", "Colaborador", "Status Kanban", 
                "Data de Registro", "Data de Previs√£o", "Data de Conclus√£o", "Detalhes"
            ];

            let csv = headers.join(";") + "\n";

            processos.forEach(p => {
                const statusText = p.dataConclusao 
                    ? (isWithinCurrentWeek(p.dataConclusao) ? 'Conclu√≠do na Semana' : 'Conclu√≠do Hist√≥rico') 
                    : (p.status === 'proximos' ? 'Pr√≥ximo' : 'Em Tratamento');
                    
                const row = [
                    `"${p.id}"`,
                    `"${p.processoNome.replace(/"/g, '""')}"`,
                    `"${p.colaborador}"`,
                    `"${statusText}"`,
                    `"${p.dataRegistro}"`,
                    `"${p.dataPrevisao || ''}"`,
                    `"${p.dataConclusao || ''}"`,
                    `"${(p.detalhes || '').replace(/"/g, '""')}"`
                ].join(";");
                
                csv += row + "\n";
            });

            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Relatorio_Processos_${getTodayDateString()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            displayReportMessage("Relat√≥rio CSV baixado com sucesso!", 'success');
        }


        // ====================================================================
        // INICIALIZA√á√ÉO
        // ====================================================================

        window.onload = function () {
            // Exp√µe fun√ß√µes globais para o HTML
            window.filterCards = filterCards;
            window.clearFilters = clearFilters;
            window.openEditModal = openEditModal;
            window.closeEditModal = closeEditModal;
            window.handleEditSubmit = handleEditSubmit;
            window.deleteProcess = deleteProcess;
            window.openReportModal = openReportModal;
            window.closeReportModal = closeReportModal;
            window.handleReportAuthentication = handleReportAuthentication;
            window.handleReportLogout = handleReportLogout;
            window.togglePinVisibility = togglePinVisibility;
            window.downloadReportAsCsv = downloadReportAsCsv;

            // Inicializa a UI do formul√°rio
            setupCollaboratorSelects(); 
            
            // Inicializa o Firebase e come√ßa a ouvir o Firestore
            initializeFirebase();
        };

    </script>
</body>
</html>
