<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Semanal de Processos</title>
    <!-- Carrega o Tailwind CSS para um layout moderno e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configura√ß√£o de Fonte Padr√£o e Estilos Globais */
        :root {
            /* Cor prim√°ria (Slate/Chumbo) */
            --color-primary: #475569; 
            --color-secondary: #64748b; 
            --color-bg: #f8fafc; /* Super Light Gray */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
        }
        
        /* Estilos customizados para as colunas do Kanban */
        .board-column {
            min-width: 300px;
            max-width: 350px;
            flex-shrink: 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
            /* Configura√ß√£o para rolagem interna na coluna */
            max-height: 70vh; /* Altura m√°xima para ativar a rolagem (70% do viewport) */
            overflow-y: auto; /* Habilita a rolagem vertical */
        }
        
        /* Estilo para fixar o t√≠tulo da coluna (Kanban Header Sticky) */
        .kanban-header-sticky {
            position: sticky;
            top: 0; /* Fixa o t√≠tulo no topo da √°rea de rolagem interna */
            z-index: 10;
            background-color: white; /* Garante que ele cubra os cards ao rolar */
            
            /* Ajusta o espa√ßamento e borda para manter a est√©tica do design */
            padding-top: 1.25rem; /* p-5 da coluna */
            margin-top: -1.25rem; /* Compensa o p-5 superior da coluna */
            padding-left: 1.25rem; /* p-5 da coluna */
            margin-left: -1.25rem; /* Compensa o p-5 esquerdo da coluna */
            padding-right: 1.25rem; /* p-5 da coluna */
            margin-right: -1.25rem; /* Compensa o p-5 direito da coluna */
            padding-bottom: 1rem; /* pb-4 original do h3 */
            margin-bottom: 0.5rem; /* mb-2 ajustado */
            
            /* Sombra sutil para efeito de flutua√ß√£o */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.06);
        }
        
        /* Estilos para a barra de rolagem (melhor compatibilidade com Webkit) */
        .board-column::-webkit-scrollbar {
            width: 8px;
        }
        .board-column::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* Cor suave do thumb (slate-300) */
            border-radius: 20px;
        }
        .board-column::-webkit-scrollbar-track {
            background-color: transparent; /* Track transparente */
        }
        .board-column:hover::-webkit-scrollbar-thumb {
            background-color: #94a3b8; /* Fica mais vis√≠vel ao passar o mouse (slate-400) */
        }
        /* Fim da rolagem interna */

        .task-card {
            transition: transform 0.2s, box-shadow 0.3s;
            border-left-width: 6px; 
            border-radius: 0.75rem; 
        }
        .task-card:hover {
            transform: translateY(-3px); 
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Cores de status - PALETA CORPORATIVA/TECNOL√ìGICA */
        /* Tratamento (Strong Orange - Aten√ß√£o/Urg√™ncia) */
        .status-tratamento { border-left-color: #ea580c; } 
        /* Tratados (Emerald Green - Sucesso/Conclus√£o - USADO PARA CONCLU√çDOS NA SEMANA) */
        .status-tratados { border-left-color: #10b981; } 
        /* Pr√≥ximos (Indigo - Planejamento/Futuro) */
        .status-proximos { border-left-color: #6366f1; } 
        /* Conclu√≠dos (Gray/Slate - Hist√≥rico/Arquivado - USADO PARA CONCLU√çDOS ANTIGOS) */
        .status-concluido-hist { border-left-color: #6b7280; } 

        /* Estilo para a data no card */
        .card-date {
            background-color: #e0f2f7; /* Azul claro suave */
            color: #155e75; /* Teal escuro */
            padding: 2px 8px;
            border-radius: 9999px; 
            font-weight: 600;
        }
        /* Estilo para a data de CONCLUS√ÉO (destaque verde) */
        .card-done {
            background-color: #d1fae5; /* Verde claro */
            color: #065f46; /* Verde escuro */
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 0.5rem;
        }
        /* Estilo para o modal */
        #edit-modal {
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Cabe√ßalho Principal Moderno com Gradient Tecnol√≥gico (Azul/√çndigo Escuro) -->
    <header class="bg-gradient-to-r from-slate-800 to-indigo-700 rounded-xl shadow-2xl p-8 mb-4 text-center">
        <h1 class="text-4xl font-black text-white">Dashboard de Acompanhamento Semanal</h1>
        <p class="text-indigo-200 mt-2 text-lg">Vis√£o din√¢mica e eficiente dos processos da equipe.</p>
    </header>

    <!-- Se√ß√£o de Filtros -->
    <div class="bg-white rounded-xl shadow-lg p-6 grid grid-cols-1 md:grid-cols-5 gap-4 items-end border-t-4 border-indigo-400 mb-8">
        <h2 class="text-xl font-bold text-slate-700 col-span-full md:col-span-5 border-b pb-2">Filtros Avan√ßados:</h2>

        <!-- Filtro por Colaborador -->
        <div class="col-span-full sm:col-span-2 lg:col-span-2">
            <label for="filter-colaborador" class="text-sm font-medium text-gray-600 mb-1">Filtrar por Colaborador</label>
            <select id="filter-colaborador" onchange="filterCards()" class="p-2 border-2 border-gray-200 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 shadow-inner w-full">
                <option value="todos" class="font-bold">Todos os Colaboradores</option>
                <!-- Op√ß√µes preenchidas pelo JS -->
            </select>
        </div>

        <!-- Filtro por Data (Previs√£o de Conclus√£o) -->
        <div class="col-span-full sm:col-span-2 lg:col-span-2">
            <label for="filter-date" class="text-sm font-medium text-gray-600 mb-1">Filtrar por Data (Previs√£o)</label>
            <input type="date" id="filter-date" onchange="filterCards()" class="p-2 border-2 border-gray-200 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 shadow-inner w-full">
        </div>

        <!-- Bot√£o Limpar Filtros -->
        <div class="col-span-full sm:col-span-1 lg:col-span-1">
            <button onclick="clearFilters()" class="bg-gray-700 text-white hover:bg-gray-800 px-4 py-2 rounded-xl font-semibold transition duration-200 shadow-md min-h-[44px] w-full mt-4 sm:mt-0">
                Limpar Filtros
            </button>
        </div>
    </div>
    
    <!-- FIM da Se√ß√£o de Filtros -->

    <!-- T√çTULO DE SE√á√ÉO para o Kanban Board -->
    <h2 class="text-3xl font-black text-slate-700 mt-8 mb-4">Kanban de Processos</h2>
    
    <!-- Dashboard Kanban -->
    <div class="flex space-x-6 overflow-x-auto pt-2 pb-6">
        
        <!-- Coluna 1: Em Tratamento -->
        <div id="column-tratamento" class="board-column bg-white p-5 rounded-2xl shadow-xl">
            <!-- kanban-header-sticky CORRETO: Fixa apenas o t√≠tulo dentro da coluna que rola -->
            <h3 class="kanban-header-sticky text-xl font-extrabold text-orange-700 border-b-4 border-orange-300 flex items-center">
                <span class="mr-2 text-2xl">üî•</span> Em Tratamento
            </h3>
            <!-- Cards inseridos aqui pelo JS -->
        </div>

        <!-- Coluna 2: Tratados na Semana (Apresenta os Conclu√≠dos nesta semana) -->
        <div id="column-tratados" class="board-column bg-white p-5 rounded-2xl shadow-xl">
            <!-- kanban-header-sticky CORRETO: Fixa apenas o t√≠tulo dentro da coluna que rola -->
            <h3 class="kanban-header-sticky text-xl font-extrabold text-emerald-600 border-b-4 border-emerald-300 flex items-center">
                <span class="mr-2 text-2xl">‚ú®</span> Tratados na Semana
            </h3>
            <!-- Cards inseridos aqui pelo JS -->
        </div>

        <!-- Coluna 3: Pr√≥ximos Processos -->
        <div id="column-proximos" class="board-column bg-white p-5 rounded-2xl shadow-xl">
            <!-- kanban-header-sticky CORRETO: Fixa apenas o t√≠tulo dentro da coluna que rola -->
            <h3 class="kanban-header-sticky text-xl font-extrabold text-indigo-600 border-b-4 border-indigo-300 flex items-center">
                <span class="mr-2 text-2xl">üöÄ</span> Pr√≥ximos Processos
            </h3>
            <!-- Cards inseridos aqui pelo JS -->
        </div>
        
        <!-- Coluna 4: Hist√≥rico de Conclu√≠dos (Conclu√≠dos antes desta semana) -->
        <div id="column-concluidos-historico" class="board-column bg-white p-5 rounded-2xl shadow-xl">
            <!-- kanban-header-sticky CORRETO: Fixa apenas o t√≠tulo dentro da coluna que rola -->
            <h3 class="kanban-header-sticky text-xl font-extrabold text-slate-600 border-b-4 border-slate-300 flex items-center">
                <span class="mr-2 text-2xl">‚úÖ</span> Hist√≥rico de Conclu√≠dos
            </h3>
            <!-- Cards inseridos aqui pelo JS (Itens com dataConclusao) -->
        </div>
        
    </div>

    <!-- Formul√°rio de Entrada de Dados -->
    <div class="bg-white rounded-xl shadow-2xl p-8 mt-8 border-l-8 border-indigo-500">
        <h2 class="text-3xl font-black text-gray-800 mb-6 border-b pb-3">‚úçÔ∏è Registrar Novo Processo (Carimbo do Tempo)</h2>
        <form id="process-form" class="grid grid-cols-1 md:grid-cols-4 gap-6">
            
            <!-- Campo Colaborador -->
            <div class="col-span-full md:col-span-1">
                <label for="colaborador" class="block text-sm font-semibold text-gray-700">Colaborador</label>
                <select id="colaborador" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-50">
                    <!-- Op√ß√µes preenchidas pelo JS -->
                </select>
            </div>

            <!-- Campo Status (IMPORTANTE: Status 'tratados' agora √© apenas um r√≥tulo) -->
            <div class="col-span-full md:col-span-1">
                <label for="processo-status" class="block text-sm font-semibold text-gray-700">Status do Processo</label>
                <select id="processo-status" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-50">
                    <option value="tratamento">Em Tratamento</option>
                    <option value="proximos">Pr√≥ximos Processos</option>
                    <!-- Mantido o valor 'tratados' para fins de estilo/edi√ß√£o, mas a coluna ser√° decidida pela data de conclus√£o -->
                    <option value="tratados">Status: Tratados (Selecione Conclus√£o abaixo)</option>
                </select>
            </div>
            
            <!-- Campo Data de Registro (Carimbo do Tempo) -->
            <div class="col-span-full md:col-span-1">
                <label for="data-registro" class="block text-sm font-semibold text-gray-700">Data de Registro (Inclus√£o)</label>
                <input type="date" id="data-registro" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-50">
            </div>

            <!-- Campo Data de Previs√£o -->
            <div class="col-span-full md:col-span-1">
                <label for="data-previsao" class="block text-sm font-semibold text-gray-700">Data de Previs√£o (Conclus√£o) - Opcional</label>
                <input type="date" id="data-previsao" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-50">
            </div>
            
            <!-- Campo Data de Conclus√£o (Chave para o novo roteamento) -->
            <div class="col-span-full md:col-span-2">
                <label for="data-conclusao" class="block text-sm font-extrabold text-emerald-700">‚≠ê Data de Conclus√£o (Opcional, se J√Å feito)</label>
                <input type="date" id="data-conclusao" class="mt-1 block w-full p-3 border-2 border-emerald-300 rounded-lg shadow-md focus:ring-emerald-500 focus:border-emerald-500 transition duration-150 bg-emerald-50">
            </div>
            
            <!-- Campo Nome do Processo -->
            <div class="col-span-full">
                <label for="processo-nome" class="block text-sm font-semibold text-gray-700">Nome do Processo/Tarefa</label>
                <input type="text" id="processo-nome" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Fechamento mensal Cliente Alpha">
            </div>

            <!-- Campo Detalhes -->
            <div class="col-span-full">
                <label for="detalhes" class="block text-sm font-semibold text-gray-700">Detalhes/Descri√ß√£o</label>
                <textarea id="detalhes" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 h-24" placeholder="O que est√° sendo feito ou o que foi/ser√° feito..."></textarea>
            </div>
            
            <!-- Bot√£o Adicionar -->
            <div class="col-span-full text-right">
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition duration-200 transform hover:scale-[1.02]">
                    Adicionar Processo
                </button>
            </div>
        </form>
    </div>

    <!-- Modal de Edi√ß√£o -->
    <div id="edit-modal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-75 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-3xl p-8 w-full max-w-lg border-t-8 border-indigo-600 relative">
                <button onclick="closeEditModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></svg>
                </button>
                <h2 class="text-2xl font-black text-slate-700 mb-6">‚úèÔ∏è Editar Processo</h2>
                
                <form id="edit-form" onsubmit="handleEditSubmit(event)">
                    <input type="hidden" id="edit-id">
                    
                    <!-- Nome do Processo -->
                    <div class="mb-4">
                        <label for="edit-nome" class="block text-sm font-semibold text-gray-700">Nome do Processo/Tarefa</label>
                        <input type="text" id="edit-nome" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                    </div>

                    <!-- Colaborador e Status -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="edit-colaborador" class="block text-sm font-semibold text-gray-700">Colaborador</label>
                            <select id="edit-colaborador" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                                <!-- Op√ß√µes preenchidas pelo JS -->
                            </select>
                        </div>
                        <div>
                            <label for="edit-status" class="block text-sm font-semibold text-gray-700">Status</label>
                            <select id="edit-status" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                                <option value="tratamento">Em Tratamento</option>
                                <option value="proximos">Pr√≥ximos Processos</option>
                                <option value="tratados">Status: Tratados</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Datas (Registro e Previs√£o) -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="edit-data-registro" class="block text-sm font-semibold text-gray-700">Data de Registro (Inclus√£o)</label>
                            <input type="date" id="edit-data-registro" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                        </div>
                        <div>
                            <label for="edit-data-previsao" class="block text-sm font-semibold text-gray-700">Data de Previs√£o - Opcional</label>
                            <input type="date" id="edit-data-previsao" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                        </div>
                    </div>
                    
                    <!-- NOVO CAMPO: Data de Conclus√£o (Em destaque no Modal) -->
                    <div class="mb-6">
                        <label for="edit-data-conclusao" class="block text-sm font-extrabold text-emerald-700">‚≠ê Data de Conclus√£o (Finalizado)</label>
                        <input type="date" id="edit-data-conclusao" class="mt-1 block w-full p-3 border-2 border-emerald-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 shadow-sm bg-emerald-50">
                    </div>

                    <!-- Detalhes -->
                    <div class="mb-6">
                        <label for="edit-detalhes" class="block text-sm font-semibold text-gray-700">Detalhes/Descri√ß√£o</label>
                        <textarea id="edit-detalhes" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 h-24 shadow-sm"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeEditModal()" class="bg-gray-200 text-gray-700 hover:bg-gray-300 font-bold py-2 px-4 rounded-xl transition duration-150 shadow-md">Cancelar</button>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition duration-150">Salvar Altera√ß√µes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- L√ìGICA JAVASCRIPT -->
    <script>
        // Lista de colaboradores em ordem alfab√©tica
        const colaboradores = [
            'Beatriz', 'Diego', 'Emily', 'Felipe', 'Hosana', 
            'Jo√£o', 'Mariane', 'Rebeca', 'Tairane', 'Thais'
        ];

        let processos = [];

        // Fun√ß√£o auxiliar para obter a data de hoje formatada (YYYY-MM-DD)
        function getTodayDateString() {
            return new Date().toISOString().split('T')[0];
        }

        /**
         * Verifica se uma data (YYYY-MM-DD) cai na semana de calend√°rio atual (Dom-S√°b).
         * @param {string} dateString Data no formato YYYY-MM-DD.
         * @returns {boolean} True se a data estiver na semana atual.
         */
        function isWithinCurrentWeek(dateString) {
            if (!dateString) return false;
            
            // Parse a data como UTC para evitar problemas de fuso hor√°rio
            const targetDate = new Date(dateString + 'T00:00:00');
            
            // Cria um objeto Date para hoje, normalizado para meia-noite
            const today = new Date();
            today.setHours(0, 0, 0, 0); 

            const oneDay = 1000 * 60 * 60 * 24;
            
            // Calcula o dia da semana atual (0=Dom, 6=S√°b)
            const dayOfWeek = today.getDay(); 
            
            // Calcula o in√≠cio da semana (√∫ltimo Domingo)
            const startOfWeek = new Date(today.getTime() - dayOfWeek * oneDay); 
            // Calcula o fim da semana (pr√≥ximo S√°bado)
            const endOfWeek = new Date(startOfWeek.getTime() + 6 * oneDay);    

            // Adiciona 23:59:59.999 ao fim da semana para garantir que o s√°bado completo seja inclu√≠do
            endOfWeek.setHours(23, 59, 59, 999);

            // Verifica se a data alvo est√° entre o in√≠cio e o fim da semana atual
            return targetDate >= startOfWeek && targetDate <= endOfWeek;
        }

        // ------------------ Fun√ß√µes de Persist√™ncia (localStorage) ------------------

        function saveProcesses() {
            try {
                localStorage.setItem('processosDashboard', JSON.stringify(processos));
            } catch (e) {
                console.error("Erro ao salvar dados no localStorage:", e);
                console.error("ERRO: N√£o foi poss√≠vel salvar os dados. Verifique as configura√ß√µes do seu navegador."); 
            }
        }

        function loadProcesses() {
            try {
                const storedProcesses = localStorage.getItem('processosDashboard');
                if (storedProcesses) {
                    const loaded = JSON.parse(storedProcesses);
                    // Garante que todos os processos tenham as chaves de data necess√°rias
                    processos = loaded.map(p => ({
                        dataRegistro: p.dataRegistro || p.data || getTodayDateString(), 
                        dataPrevisao: p.dataPrevisao || p.data || '', 
                        dataConclusao: p.dataConclusao || '', // Novo campo inicializado como vazio
                        ...p,
                    }));
                }
            } catch (e) {
                console.error("Erro ao carregar dados do localStorage:", e);
                processos = [];
            }
        }
        
        // ------------------ Fun√ß√µes de UI ------------------

        function setupCollaboratorSelects() {
            const selects = [
                document.getElementById('filter-colaborador'),
                document.getElementById('colaborador'),
                document.getElementById('edit-colaborador')
            ];

            // Define o valor padr√£o para a Data de Registro
            document.getElementById('data-registro').value = getTodayDateString();

            colaboradores.forEach(nome => {
                const option = document.createElement('option');
                option.value = nome;
                option.textContent = nome;

                selects.forEach(select => select.appendChild(option.cloneNode(true)));
            });
        }
        
        // Fun√ß√£o auxiliar para formatar datas
        function formatDate(dateString) {
            if (!dateString) return null;
            // Adapta√ß√£o para garantir que datas YYYY-MM-DD sejam lidas corretamente como UTC para evitar problemas de fuso hor√°rio
            const dateObj = new Date(dateString + 'T00:00:00');
            if (!isNaN(dateObj) && dateObj.getFullYear() > 1900) {
                // Formato brasileiro DD/MM/AAAA
                return dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }
            return 'Data Inv√°lida';
        }

        function createCard(processo) {
            // Se o processo tem data de conclus√£o, verifica se √© hist√≥rico (antigo) ou da semana (recente)
            let statusClass;
            // A classe √© usada apenas para a cor da borda esquerda
            statusClass = isWithinCurrentWeek(processo.dataConclusao) ? 'tratados' : (processo.dataConclusao ? 'concluido-hist' : (processo.status === 'proximos' ? 'proximos' : 'tratamento'));

            const card = document.createElement('div');
            card.className = `task-card bg-white p-4 rounded-xl shadow-lg mb-4 text-sm status-${statusClass}`;
            
            card.setAttribute('data-colaborador', processo.colaborador);
            card.setAttribute('data-previsao', processo.dataPrevisao || '');
            card.setAttribute('data-status', processo.status);

            const previsaoDisplay = formatDate(processo.dataPrevisao) || 'Indefinida';
            const registroDisplay = formatDate(processo.dataRegistro) || 'Indefinida';
            const conclusaoDisplay = formatDate(processo.dataConclusao); 
            
            // Renderiza o campo de conclus√£o se estiver presente
            let conclusaoHtml = '';
            if (conclusaoDisplay) {
                // O texto aqui √© din√¢mico para destacar que √© Conclu√≠do na Semana ou Conclu√≠do no Hist√≥rico
                const conclusaoText = isWithinCurrentWeek(processo.dataConclusao) ? 'Conclu√≠do Esta Semana' : 'Conclu√≠do em Hist√≥rico';
                conclusaoHtml = `<span class="card-done text-xs" title="${conclusaoText}">‚úÖ ${conclusaoDisplay}</span>`;
            }

            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="font-extrabold text-gray-800 text-base">${processo.nome}</div>
                    <div class="flex space-x-2">
                        <button onclick="openEditModal(${processo.id})" title="Editar Processo" class="text-gray-400 hover:text-indigo-600 transition duration-150 p-1 rounded-full focus:outline-none">
                            <!-- √çcone de L√°pis -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                        </button>
                        <button onclick="deleteProcess(${processo.id})" title="Excluir Processo" class="text-gray-400 hover:text-red-600 transition duration-150 p-1 rounded-full focus:outline-none">
                            <!-- √çcone de Lixeira -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-between items-center mb-2">
                    <div class="text-xs text-gray-500">Colab: <span class="font-bold text-gray-700">${processo.colaborador}</span></div>
                    <span class="card-date text-xs" title="Previs√£o de Conclus√£o">Prev.: ${previsaoDisplay}</span>
                </div>
                
                <!-- Nova linha para a data de conclus√£o, se houver -->
                <div class="flex justify-between items-center mt-2 mb-2">
                    <div class="text-xs text-gray-400">Registro: ${registroDisplay}</div>
                    ${conclusaoHtml}
                </div>
                
                <div class="text-gray-600 whitespace-pre-wrap mt-3 pt-3 border-t border-gray-100">${processo.detalhes}</div>
            `;
            return card;
        }

        function renderDashboard() {
            // 1. Inicializa arrays para as colunas
            const tratamento = [];
            const tratadosSemana = [];
            const proximos = [];
            const historico = [];

            // 2. Classifica os processos nas listas
            processos.forEach(processo => {
                const isConcluido = !!processo.dataConclusao;

                if (isConcluido) {
                    if (isWithinCurrentWeek(processo.dataConclusao)) {
                        tratadosSemana.push(processo);
                    } else {
                        historico.push(processo);
                    }
                } else {
                    switch (processo.status) {
                        case 'proximos':
                            proximos.push(processo);
                            break;
                        case 'tratamento':
                        case 'tratados': // Qualquer outro status n√£o conclu√≠do vai para tratamento
                        default:
                            tratamento.push(processo);
                            break;
                    }
                }
            });
            
            // 3. ORDENA√á√ÉO: Ordena o Hist√≥rico de Conclu√≠dos por Data de Conclus√£o (Mais Recente Primeiro)
            historico.sort((a, b) => {
                // Compara as strings YYYY-MM-DD em ordem decrescente (b antes de a)
                if (!a.dataConclusao) return 1; // Itens sem dataConclusao v√£o para o final
                if (!b.dataConclusao) return -1; // Itens sem dataConclusao v√£o para o final
                return b.dataConclusao.localeCompare(a.dataConclusao);
            });
            
            // 4. Limpa e recria os t√≠tulos das colunas
            document.getElementById('column-tratamento').innerHTML = '<h3 class="kanban-header-sticky text-xl font-extrabold text-orange-700 border-b-4 border-orange-300 flex items-center"><span class="mr-2 text-2xl">üî•</span> Em Tratamento</h3>';
            document.getElementById('column-tratados').innerHTML = '<h3 class="kanban-header-sticky text-xl font-extrabold text-emerald-600 border-b-4 border-emerald-300 flex items-center"><span class="mr-2 text-2xl">‚ú®</span> Tratados na Semana</h3>';
            document.getElementById('column-proximos').innerHTML = '<h3 class="kanban-header-sticky text-xl font-extrabold text-indigo-600 border-b-4 border-indigo-300 flex items-center"><span class="mr-2 text-2xl">üöÄ</span> Pr√≥ximos Processos</h3>';
            document.getElementById('column-concluidos-historico').innerHTML = '<h3 class="kanban-header-sticky text-xl font-extrabold text-slate-600 border-b-4 border-slate-300 flex items-center"><span class="mr-2 text-2xl">‚úÖ</span> Hist√≥rico de Conclu√≠dos</h3>';

            // 5. Renderiza os cards das listas ORDENADAS
            
            // Coluna Tratamento
            tratamento.forEach(processo => document.getElementById('column-tratamento').appendChild(createCard(processo)));
            
            // Coluna Tratados na Semana
            tratadosSemana.forEach(processo => document.getElementById('column-tratados').appendChild(createCard(processo)));

            // Coluna Pr√≥ximos
            proximos.forEach(processo => document.getElementById('column-proximos').appendChild(createCard(processo)));

            // Coluna Hist√≥rico (Ordenada)
            historico.forEach(processo => document.getElementById('column-concluidos-historico').appendChild(createCard(processo)));

            filterCards(); // Aplica os filtros atuais ap√≥s a renderiza√ß√£o
        }

        // ------------------ Fun√ß√µes de Edi√ß√£o ------------------

        function openEditModal(id) {
            const processo = processos.find(p => p.id === id);
            if (!processo) {
                console.error(`Processo com ID ${id} n√£o encontrado para edi√ß√£o.`);
                return;
            }

            // Preenche o formul√°rio do modal com os dados do processo
            document.getElementById('edit-id').value = processo.id;
            document.getElementById('edit-nome').value = processo.nome;
            document.getElementById('edit-colaborador').value = processo.colaborador;
            document.getElementById('edit-status').value = processo.status;
            document.getElementById('edit-data-registro').value = processo.dataRegistro;
            
            // Preenche a data de previs√£o (pode ser string vazia)
            document.getElementById('edit-data-previsao').value = processo.dataPrevisao || ''; 
            // NOVO: Preenche a data de conclus√£o (pode ser string vazia)
            document.getElementById('edit-data-conclusao').value = processo.dataConclusao || ''; 
            
            document.getElementById('edit-detalhes').value = processo.detalhes;

            // Mostra o modal
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        function handleEditSubmit(e) {
            e.preventDefault();

            const id = parseInt(document.getElementById('edit-id').value);
            const index = processos.findIndex(p => p.id === id);

            if (index === -1) {
                console.error(`Erro ao salvar: Processo com ID ${id} n√£o encontrado.`);
                return;
            }

            // Sanitiza os valores (opcionais podem ser string vazia)
            const dataPrevisao = document.getElementById('edit-data-previsao').value.trim();
            const dataConclusao = document.getElementById('edit-data-conclusao').value.trim(); 

            // Atualiza o objeto processo
            processos[index] = {
                ...processos[index], 
                colaborador: document.getElementById('edit-colaborador').value,
                status: document.getElementById('edit-status').value,
                nome: document.getElementById('edit-nome').value,
                dataRegistro: document.getElementById('edit-data-registro').value,
                dataPrevisao: dataPrevisao, 
                dataConclusao: dataConclusao, 
                detalhes: document.getElementById('edit-detalhes').value || 'Nenhum detalhe fornecido.',
            };

            saveProcesses();
            renderDashboard();
            closeEditModal();
            console.log(`Processo ${id} editado com sucesso.`);
        }


        // ------------------ Fun√ß√µes de A√ß√£o (Excluir) ------------------

        function deleteProcess(id) {
            const initialLength = processos.length;
            processos = processos.filter(processo => processo.id !== id);

            if (processos.length < initialLength) {
                saveProcesses();
                renderDashboard();
                console.log(`Processo com ID ${id} exclu√≠do com sucesso.`);
            } else {
                console.warn(`Processo com ID ${id} n√£o encontrado.`);
            }
        }

        // ------------------ Fun√ß√µes de Filtro ------------------
        
        function filterCards() {
            const filterColab = document.getElementById('filter-colaborador').value;
            const filterDate = document.getElementById('filter-date').value;
            const allCards = document.querySelectorAll('.task-card');

            allCards.forEach(card => {
                const cardColab = card.getAttribute('data-colaborador');
                const cardPrevisao = card.getAttribute('data-previsao'); 
                let matches = true;

                // 1. Filtro por Colaborador
                if (filterColab !== 'todos' && cardColab !== filterColab) {
                    matches = false;
                }

                // 2. Filtro por Data (Previs√£o)
                if (filterDate && cardPrevisao !== filterDate) {
                    matches = false;
                }

                card.style.display = matches ? 'block' : 'none';
            });
        }
        
        function clearFilters() {
            document.getElementById('filter-colaborador').value = 'todos';
            document.getElementById('filter-date').value = '';
            filterCards();
        }

        // ------------------ Manipula√ß√£o do Formul√°rio (Registro) ------------------

        document.getElementById('process-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const dataPrevisaoValue = document.getElementById('data-previsao').value.trim();
            const dataRegistroValue = document.getElementById('data-registro').value;
            const dataConclusaoValue = document.getElementById('data-conclusao').value.trim(); 

            const novoProcesso = {
                colaborador: document.getElementById('colaborador').value,
                status: document.getElementById('processo-status').value,
                nome: document.getElementById('processo-nome').value,
                dataRegistro: dataRegistroValue,
                dataPrevisao: dataPrevisaoValue,
                dataConclusao: dataConclusaoValue, 
                detalhes: document.getElementById('detalhes').value || 'Nenhum detalhe fornecido.',
                id: Date.now() 
            };

            processos.push(novoProcesso);
            saveProcesses();
            renderDashboard();
            
            // Limpa campos espec√≠ficos
            document.getElementById('processo-nome').value = '';
            document.getElementById('data-previsao').value = ''; 
            document.getElementById('data-conclusao').value = ''; 
            document.getElementById('detalhes').value = '';
            
            document.getElementById('data-registro').value = getTodayDateString(); 
            
            console.log(`Processo "${novoProcesso.nome}" adicionado para ${novoProcesso.colaborador}!`);
        });

        // ------------------ Inicializa√ß√£o ------------------
        
        // Define alguns dados iniciais se n√£o houver nada salvo no localStorage
        function setInitialData() {
            if (processos.length === 0) {
                const today = getTodayDateString();
                const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0]; 
                const twoDaysAgo = new Date(Date.now() - 2 * 86400000).toISOString().split('T')[0]; 
                const nextWeek = new Date(Date.now() + 7 * 86400000).toISOString().split('T')[0];
                const lastWeek = new Date(Date.now() - 7 * 86400000).toISOString().split('T')[0];
                const twoWeeksAgo = new Date(Date.now() - 14 * 86400000).toISOString().split('T')[0];

                processos = [
                    // 1. Em Tratamento (N√£o Conclu√≠do)
                    { colaborador: 'Beatriz', status: 'tratamento', nome: 'An√°lise de Relat√≥rio de Custos', dataRegistro: yesterday, dataPrevisao: today, dataConclusao: '', detalhes: 'Revisando as despesas de TI e Pessoal. Prioridade alta.', id: 1 },
                    
                    // 2. Tratados na Semana (A data de conclus√£o √© hoje, ent√£o cai na coluna TRATADOS NA SEMANA)
                    { colaborador: 'Diego', status: 'tratados', nome: 'Migra√ß√£o de Servidor Cloud', dataRegistro: yesterday, dataPrevisao: yesterday, dataConclusao: today, detalhes: 'Migra√ß√£o para novo ambiente AWS conclu√≠da com sucesso e documentada.', id: 2 },
                    
                    // 3. Hist√≥rico de Conclu√≠dos (Este √© o MAIS RECENTE do hist√≥rico - aparecer√° primeiro)
                    { colaborador: 'Mariane', status: 'tratados', nome: 'Fechamento Cont√°bil do M√™s', dataRegistro: twoDaysAgo, dataPrevisao: lastWeek, dataConclusao: yesterday, detalhes: 'Fechamento finalizado e documentos enviados ao setor financeiro.', id: 6 },
                    
                    // 4. Hist√≥rico de Conclu√≠dos (Este √© o MAIS ANTIGO do hist√≥rico - aparecer√° por √∫ltimo)
                    { colaborador: 'Felipe', status: 'tratados', nome: 'Revis√£o Contratual Cliente Gama', dataRegistro: lastWeek, dataPrevisao: lastWeek, dataConclusao: twoWeeksAgo, detalhes: 'Contrato revisto e assinado. Processo de arquivamento finalizado.', id: 5 },
                    
                    // 5. Pr√≥ximos Processos (N√£o Conclu√≠do)
                    { colaborador: 'Emily', status: 'proximos', nome: 'Planejamento de Campanha Q4', dataRegistro: today, dataPrevisao: nextWeek, dataConclusao: '', detalhes: 'Definir budget, criar criativos e segmentar p√∫blico-alvo.', id: 3 },
                    
                    // 6. Em Tratamento (N√£o Conclu√≠do)
                    { colaborador: 'Jo√£o', status: 'tratamento', nome: 'Atendimento Cliente Y (Chamado 456)', dataRegistro: today, dataPrevisao: '', dataConclusao: '', detalhes: 'Aguardando feedback do cliente sobre a proposta enviada.', id: 4 },
                ];
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            setupCollaboratorSelects(); 
            loadProcesses(); 
            setInitialData(); 
            renderDashboard(); 
        });

    </script>
</body>
</html>
